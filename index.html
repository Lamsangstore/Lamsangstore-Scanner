<!DOCTYPE html>
<html>
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <meta http-equiv="Permissions-Policy" content="camera=*">
Â  <title>Lamsangstore â€” Scanner</title>
Â  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZjY5YjQ7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmODVjMjtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9InNoaW5lR3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZmZmZmO3N0b3Atb3BhY2l0eTowLjM1IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmZmZmY7c3RvcC1vcGFjaXR5OjAiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KCiAgPCEtLSDguJ7guLfguYnguJnguKvguKXguLHguIfguIHguKXguKEgLS0+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDgiIGZpbGw9InVybCgjYmdHcmFkKSIgLz4KICA8IS0tIHNoaW5lIG92ZXJsYXkgLS0+CiAgPGVsbGlwc2UgY3g9IjUwIiBjeT0iMzAiIHJ4PSIzMCIgcnk9IjIwIiBmaWxsPSJ1cmwoI3NoaW5lR3JhZCkiIC8+CgogIDwhLS0g4LiB4Lil4LmI4Lit4LiH4Lie4Lix4Liq4LiU4Li4IC0tPgogIDxyZWN0IHg9IjIyIiB5PSI0MiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjM4IiByeD0iNSIgcnk9IjUiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuOTUiLz4KICA8IS0tIOC4neC4suC4geC4peC5iOC4reC4hyAtLT4KICA8cGF0aCBkPSJNMjAgNDQgUTUwIDM2IDgwIDQ0IEw4MCA0MiBRNTAgMzIgMjAgNDIgWiIgZmlsbD0iI2ZmZTBmMCIgb3BhY2l0eT0iMC45Ii8+CiAgPHBhdGggZD0iTTIwIDQyIEw1MCAzNCBMODAgNDIiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmNjliNCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CiAgPCEtLSDguYDguKrguYnguJnguIHguKXguLLguIfguJ3guLIgLS0+CiAgPGxpbmUgeDE9IjUwIiB5MT0iMzQiIHgyPSI1MCIgeTI9IjQ0IiBzdHJva2U9IiNmZjY5YjQiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtZGFzaGFycmF5PSIyLDIiLz4KICA8IS0tIHJpYmJvbiDguJrguJnguIHguKXguYjguK3guIcgLS0+CiAgPHJlY3QgeD0iNDQiIHk9IjQyIiB3aWR0aD0iMTIiIGhlaWdodD0iMzgiIHJ4PSIyIiBmaWxsPSIjZmZiNmQ5IiBvcGFjaXR5PSIwLjUiLz4KICA8IS0tIOC5guC4muC4p+C5jCAtLT4KICA8cGF0aCBkPSJNNTAgMzggUTQyIDMyIDM4IDM1IFE0MiAzOCA1MCAzOCIgZmlsbD0iI2ZmNjliNCIvPgogIDxwYXRoIGQ9Ik01MCAzOCBRNTggMzIgNjIgMzUgUTU4IDM4IDUwIDM4IiBmaWxsPSIjZmY2OWI0Ii8+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSIzOCIgcj0iMyIgZmlsbD0iI2ZmZiIgc3Ryb2tlPSIjZmY2OWI0IiBzdHJva2Utd2lkdGg9IjEiLz4KCiAgPCEtLSDguJTguLLguKfguYDguKXguYfguIHguYYgLS0+CiAgPHRleHQgeD0iMTgiIHk9IjM4IiBmb250LXNpemU9IjkiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuOSI+4pymPC90ZXh0PgogIDx0ZXh0IHg9Ijc0IiB5PSIzNiIgZm9udC1zaXplPSI3IiBmaWxsPSIjZmZmIiBvcGFjaXR5PSIwLjgiPuKcpjwvdGV4dD4KICA8dGV4dCB4PSIyNiIgeT0iODIiIGZvbnQtc2l6ZT0iNiIgZmlsbD0iI2ZmNjliNCIgb3BhY2l0eT0iMC42Ij7inKY8L3RleHQ+CgogIDwhLS0g4LiV4Lix4Lin4Lit4Lix4LiB4Lip4LijIEwgLS0+CiAgPHRleHQgeD0iNTAiIHk9IjcyIiAKICAgICAgICBmb250LWZhbWlseT0iR2VvcmdpYSwgc2VyaWYiIAogICAgICAgIGZvbnQtc2l6ZT0iMjIiIAogICAgICAgIGZvbnQtd2VpZ2h0PSJib2xkIgogICAgICAgIGZpbGw9IiNmZjY5YjQiCiAgICAgICAgdGV4dC1hbmNob3I9Im1pZGRsZSIKICAgICAgICBsZXR0ZXItc3BhY2luZz0iMSI+TDwvdGV4dD4KPC9zdmc+Cg==">

Â  <script src="https://unpkg.com/html5-qrcode"></script>
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
Â  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

Â  <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
Â  <style>
Â  Â  :root {
Â  Â  Â  --pink:Â  Â  Â  Â  #ff8fab;
Â  Â  Â  --pink-light:Â  #ffccd5;
Â  Â  Â  --pink-pale:Â  Â #fff0f3;
Â  Â  Â  --peach:Â  Â  Â  Â #ffd6a5;
Â  Â  Â  --lilac:Â  Â  Â  Â #c8b6ff;
Â  Â  Â  --mint:Â  Â  Â  Â  #b9fbc0;
Â  Â  Â  --cream:Â  Â  Â  Â #fff8f0;
Â  Â  Â  --brown:Â  Â  Â  Â #8b5e52;
Â  Â  Â  --text:Â  Â  Â  Â  #5a3e4b;
Â  Â  Â  --text2:Â  Â  Â  Â #7a5e6b;
Â  Â  Â  --text3:Â  Â  Â  Â #c49aaa;
Â  Â  Â  --card-bg:Â  Â  Â rgba(255,255,255,0.85);
Â  Â  Â  --surface:Â  Â  Â #ffffff;
Â  Â  Â  --surface2:Â  Â  #fff0f3;
Â  Â  Â  --border:Â  Â  Â  rgba(255,204,213,0.5);
Â  Â  Â  --border2:Â  Â  Â #ffccd5;
Â  Â  Â  --success:Â  Â  Â #2d9e6b;
Â  Â  Â  --danger:Â  Â  Â  #d63031;
Â  Â  Â  --warning:Â  Â  Â #e17055;
Â  Â  Â  --info:Â  Â  Â  Â  #0984e3;
Â  Â  Â  --nav-h:Â  Â  Â  Â 64px;
Â  Â  Â  --topbar-h:Â  Â  58px;
Â  Â  Â  --radius:Â  Â  Â  24px;
Â  Â  Â  --radius-sm:Â  Â 16px;
Â  Â  Â  --radius-xs:Â  Â 10px;
Â  Â  }

Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; }

Â  Â  body {
Â  Â  Â  background: var(--pink-pale);
Â  Â  Â  font-family: 'Mitr', 'Sarabun', sans-serif;
Â  Â  Â  font-size: 17px;
Â  Â  Â  color: var(--text);
Â  Â  Â  min-height: 100vh;
Â  Â  Â  overflow-x: hidden;
Â  Â  Â  padding-top: var(--topbar-h);
Â  Â  Â  padding-bottom: calc(var(--nav-h) + 28px);
Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  }

Â  Â  body::before {
Â  Â  Â  content: '';
Â  Â  Â  position: fixed; inset: 0; z-index: -2;
Â  Â  Â  background:
Â  Â  Â  Â  radial-gradient(ellipse 80% 60% at 10% 10%, #ffe0ec 0%, transparent 60%),
Â  Â  Â  Â  radial-gradient(ellipse 60% 50% at 90% 90%, #f0d9ff 0%, transparent 60%),
Â  Â  Â  Â  radial-gradient(ellipse 50% 40% at 50% 50%, #fff0d6 0%, transparent 70%);
Â  Â  }

Â  Â  /* ===== TOP APP BAR ===== */
Â  Â  #app-header {
Â  Â  Â  position: fixed; top: 0; left: 0; right: 0;
Â  Â  Â  height: var(--topbar-h);
Â  Â  Â  background: rgba(255,255,255,0.82);
Â  Â  Â  backdrop-filter: blur(16px);
Â  Â  Â  -webkit-backdrop-filter: blur(16px);
Â  Â  Â  border-bottom: 1px solid var(--pink-light);
Â  Â  Â  display: flex; align-items: center;
Â  Â  Â  padding: 0 16px; z-index: 100;
Â  Â  Â  box-shadow: 0 2px 12px rgba(255,143,171,0.1);
Â  Â  }
Â  Â  .topbar-logo {
Â  Â  Â  width: 36px; height: 36px; border-radius: 12px;
Â  Â  Â  background: linear-gradient(135deg, var(--pink), #ff6b9d);
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  font-size: 1.2rem; flex-shrink: 0;
Â  Â  Â  box-shadow: 0 3px 10px rgba(255,143,171,0.4);
Â  Â  }
Â  Â  .topbar-title {
Â  Â  Â  font-size: 1.15rem; font-weight: 600;
Â  Â  Â  color: var(--text); margin-left: 10px;
Â  Â  Â  flex: 1; line-height: 1.25;
Â  Â  }
Â  Â  .topbar-sub {
Â  Â  Â  font-size: 0.82rem; color: var(--text3);
Â  Â  Â  display: block; font-weight: 400;
Â  Â  }

Â  Â  /* ===== BOTTOM NAV ===== */
Â  Â  #app-tabs {
Â  Â  Â  position: fixed; bottom: 10px; left: 12px; right: 12px;
Â  Â  Â  height: var(--nav-h);
Â  Â  Â  background: rgba(255,255,255,0.88);
Â  Â  Â  backdrop-filter: blur(20px);
Â  Â  Â  -webkit-backdrop-filter: blur(20px);
Â  Â  Â  border: 1.5px solid rgba(255,204,213,0.6);
Â  Â  Â  border-radius: 26px;
Â  Â  Â  display: flex; justify-content: space-around; align-items: center;
Â  Â  Â  z-index: 100; padding: 6px;
Â  Â  Â  box-shadow: 0 8px 32px rgba(255,143,171,0.2), 0 2px 8px rgba(0,0,0,0.06);
Â  Â  }
Â  Â  .tab-btn {
Â  Â  Â  border: none; background: transparent;
Â  Â  Â  display: flex; flex-direction: column; align-items: center;
Â  Â  Â  gap: 3px; padding: 7px 10px; border-radius: 20px;
Â  Â  Â  color: var(--text3); font-size: 0.82rem; font-weight: 500;
Â  Â  Â  transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
Â  Â  Â  cursor: pointer; font-family: 'Mitr', sans-serif;
Â  Â  Â  flex: 1;
Â  Â  }
Â  Â  .tab-btn .tab-icon { font-size: 1.4rem; line-height: 1; transition: transform 0.2s; }
Â  Â  .tab-btn.active {
Â  Â  Â  background: linear-gradient(135deg, var(--pink-light), #f0d0ff);
Â  Â  Â  color: var(--text);
Â  Â  Â  box-shadow: 0 3px 12px rgba(255,143,171,0.3);
Â  Â  }
Â  Â  .tab-btn.active .tab-icon { transform: scale(1.1); }
Â  Â  .tab-btn:hover:not(.active) { background: var(--pink-pale); color: var(--text2); }
Â  Â  .tab-btn-upload { color: var(--pink) !important; }
Â  Â  .tab-btn-upload:hover { background: var(--pink-pale) !important; }

Â  Â  /* ===== MAIN CONTENT ===== */
Â  Â  .page-content { padding: 14px 14px 0; max-width: 500px; margin: 0 auto; }

Â  Â  /* ===== SECTION HEADER ===== */
Â  Â  .section-title {
Â  Â  Â  font-size: 0.85rem; font-weight: 600;
Â  Â  Â  color: var(--text3); letter-spacing: 0.3px;
Â  Â  Â  margin-bottom: 6px; margin-top: 14px; padding-left: 2px;
Â  Â  }

Â  Â  /* ===== CARDS ===== */
Â  Â  .card {
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  border: 1.5px solid rgba(255,204,213,0.4);
Â  Â  Â  background: rgba(255,255,255,0.85);
Â  Â  Â  backdrop-filter: blur(16px);
Â  Â  Â  -webkit-backdrop-filter: blur(16px);
Â  Â  Â  box-shadow: 0 8px 32px rgba(255,143,171,0.1), 0 2px 8px rgba(0,0,0,0.04);
Â  Â  }

Â  Â  /* ===== SCANNER ===== */
Â  Â  #reader, #search-reader {
Â  Â  Â  width: 100%; max-width: 440px; margin: auto;
Â  Â  Â  border-radius: 14px; overflow: hidden;
Â  Â  Â  border: 3px solid var(--surface);
Â  Â  Â  box-shadow: 0 0 0 2px var(--pink-light), 0 4px 16px rgba(0,0,0,0.08);
Â  Â  }

Â  Â  /* ===== BUTTONS ===== */
Â  Â  .btn-custom {
Â  Â  Â  border-radius: var(--radius-sm); padding: 14px 16px;
Â  Â  Â  font-weight: 600; font-size: 1.05rem;
Â  Â  Â  border: none; transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
Â  Â  Â  font-family: 'Mitr', sans-serif;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  .btn-custom:hover { transform: translateY(-2px); }
Â  Â  .btn-custom:active { transform: scale(0.97); }

Â  Â  .btn-main {
Â  Â  Â  background: linear-gradient(135deg, #74b9ff, #0984e3);
Â  Â  Â  color: white;
Â  Â  Â  box-shadow: 0 4px 16px rgba(9,132,227,0.3);
Â  Â  }
Â  Â  .btn-save {
Â  Â  Â  background: linear-gradient(135deg, var(--pink), #e84393);
Â  Â  Â  color: white;
Â  Â  Â  box-shadow: 0 4px 16px rgba(255,143,171,0.4);
Â  Â  }
Â  Â  .btn-cancel {
Â  Â  Â  background: linear-gradient(135deg, #b2bec3, #636e72);
Â  Â  Â  color: white;
Â  Â  }

Â  Â  /* ===== STATUS BADGE ===== */
Â  Â  .status-badge {
Â  Â  Â  display: inline-block;
Â  Â  Â  padding: 8px 20px; border-radius: 50px;
Â  Â  Â  font-size: 0.95rem; font-weight: 500;
Â  Â  Â  margin-top: 10px; transition: all 0.4s ease;
Â  Â  Â  font-family: 'Mitr', sans-serif;
Â  Â  }

Â  Â  /* ===== REC UI ===== */
Â  Â  #rec-ui {
Â  Â  Â  min-height: 46px; display: flex;
Â  Â  Â  align-items: center; justify-content: center;
Â  Â  Â  background: var(--surface2);
Â  Â  Â  border: 1px solid var(--border) !important;
Â  Â  Â  border-radius: var(--radius-sm) !important;
Â  Â  }
Â  Â  #video-preview { display: none; }
Â  Â  .rec-indicator { display: flex; align-items: center; font-size: 11px; font-weight: 500; color: var(--text2); letter-spacing: 0.3px; }
Â  Â  .rec-dot {
Â  Â  Â  width: 7px; height: 7px; background: var(--danger);
Â  Â  Â  border-radius: 50%; margin-right: 8px;
Â  Â  Â  animation: blink 1.2s infinite;
Â  Â  }
Â  Â  @keyframes spin { to { transform: rotate(360deg); } }
Â  Â  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.15; } }

Â  Â  /* ===== LIST ITEMS ===== */
Â  Â  .list-group-item {
Â  Â  Â  border: none !important;
Â  Â  Â  background: linear-gradient(135deg, #fff0f3, #fff8ff);
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  border-radius: var(--radius-sm) !important;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  border-left: 3px solid var(--pink-light) !important;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  font-size: 1.02rem;
Â  Â  }
Â  Â  .list-group-item:hover { transform: translateX(3px); border-left-color: var(--pink) !important; }

Â  Â  /* ===== EDIT BUTTON ===== */
Â  Â  .btn-edit-inline {
Â  Â  Â  padding: 3px 12px; font-size: 0.78rem;
Â  Â  Â  border-radius: 10px; margin-left: 8px;
Â  Â  Â  border: 1.5px solid var(--pink-light);
Â  Â  Â  background: white; color: var(--pink);
Â  Â  Â  transition: all 0.2s; cursor: pointer;
Â  Â  }
Â  Â  .btn-edit-inline:hover { background: var(--pink-light); }

Â  Â  /* ===== UPLOAD BUTTON ===== */
Â  Â  .btn-upload-head {
Â  Â  Â  border-radius: var(--radius-xs); font-weight: 600;
Â  Â  Â  font-size: 0.85rem; padding: 8px 16px;
Â  Â  Â  background: white;
Â  Â  Â  border: 1.5px solid var(--pink-light) !important;
Â  Â  Â  color: var(--pink) !important;
Â  Â  Â  transition: all 0.2s; white-space: nowrap;
Â  Â  Â  box-shadow: 0 3px 12px rgba(255,143,171,0.25);
Â  Â  }
Â  Â  .btn-upload-head:hover { background: var(--pink); color: white !important; border-color: var(--pink) !important; }

Â  Â  /* ===== CHECKLIST ===== */
Â  Â  .order-checklist {
Â  Â  Â  background: linear-gradient(135deg, #fff8ff, #fff0f3);
Â  Â  Â  border-radius: var(--radius); padding: 14px;
Â  Â  Â  border: 2px dashed var(--pink-light) !important;
Â  Â  Â  margin-top: 14px; display: none;
Â  Â  }
Â  Â  .checklist-item {
Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  padding: 9px 10px; border-bottom: 1px solid #ffe4ec;
Â  Â  Â  font-size: 1rem; border-radius: 8px; margin-bottom: 2px;
Â  Â  }
Â  Â  .checklist-item:last-child { border-bottom: none; }
Â  Â  .checklist-item.matched { background: #e8fff0; color: var(--success); font-weight: 600; }
Â  Â  .checklist-item.overÂ  Â  { background: #fff0f0; color: var(--danger); font-weight: 600; }

Â  Â  /* ===== REMARK PANEL ===== */
Â  Â  .remark-panel {
Â  Â  Â  background: linear-gradient(135deg, #fffbeb, #fff8e1);
Â  Â  Â  border-radius: var(--radius); padding: 12px;
Â  Â  Â  border: 2px solid #ffd166; margin-top: 10px; display: none;
Â  Â  }
Â  Â  .remark-btn {
Â  Â  Â  border-radius: var(--radius-sm); padding: 7px 16px;
Â  Â  Â  font-size: 0.92rem; font-weight: 500; margin: 3px;
Â  Â  Â  border: 2px solid #ffd166; background: white;
Â  Â  Â  cursor: pointer; transition: all 0.2s;
Â  Â  Â  font-family: 'Mitr', sans-serif;
Â  Â  }
Â  Â  .remark-btn:hover, .remark-btn.selected { background: #ffd166; border-color: #ffd166; color: #5a3e00; }

Â  Â  /* ===== PARCEL INFO BOX ===== */
Â  Â  .parcel-box {
Â  Â  Â  background: linear-gradient(135deg, rgba(255,240,243,0.7), rgba(255,248,255,0.7));
Â  Â  Â  border: 1.5px solid var(--pink-light);
Â  Â  Â  border-radius: var(--radius); padding: 14px;
Â  Â  }



Â  Â  /* ===== MODAL ===== */
Â  Â  .modal-content {
Â  Â  Â  border-radius: var(--radius) !important;
Â  Â  Â  border: 1.5px solid var(--pink-light);
Â  Â  }
Â  Â  .modal-header {
Â  Â  Â  background: linear-gradient(135deg, var(--pink), #ff6b9d) !important;
Â  Â  Â  border-radius: calc(var(--radius) - 1px) calc(var(--radius) - 1px) 0 0 !important;
Â  Â  Â  padding: 14px 18px !important;
Â  Â  }
Â  Â  .modal-title { color: white !important; font-size: 1rem !important; font-weight: 600 !important; }

Â  Â  /* ===== DASHBOARD CARDS ===== */
Â  Â  .stat-card {
Â  Â  Â  border-radius: var(--radius); padding: 20px;
Â  Â  Â  background: rgba(255,255,255,0.85);
Â  Â  Â  border: 1.5px solid var(--pink-light);
Â  Â  Â  text-align: center;
Â  Â  Â  backdrop-filter: blur(12px);
Â  Â  }
Â  Â  .stat-num {
Â  Â  Â  font-size: 3rem; font-weight: 600;
Â  Â  Â  background: linear-gradient(135deg, var(--pink), #b57bee);
Â  Â  Â  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
Â  Â  Â  background-clip: text;
Â  Â  }

Â  Â  /* ===== SCROLLBAR ===== */
Â  Â  ::-webkit-scrollbar { width: 6px; }
Â  Â  ::-webkit-scrollbar-track { background: var(--pink-pale); }
Â  Â  ::-webkit-scrollbar-thumb { background: var(--pink-light); border-radius: 10px; }

Â  Â  /* ===== ANIMATE ===== */
Â  Â  .fade-in-up { animation: fadeInUp 0.25s ease both; }
Â  Â  @keyframes fadeInUp {
Â  Â  Â  from { opacity: 0; transform: translateY(8px); }
Â  Â  Â  toÂ  Â { opacity: 1; transform: translateY(0); }
Â  Â  }

Â  Â  /* refresh button */
Â  Â  #refreshCacheBtn {
Â  Â  Â  border-radius: var(--radius-sm) !important;
Â  Â  Â  border: 1.5px solid var(--pink-light) !important;
Â  Â  Â  color: var(--pink) !important;
Â  Â  Â  font-family: 'Mitr', sans-serif;
Â  Â  Â  font-size: 0.85rem; transition: all 0.2s;
Â  Â  }
Â  Â  #refreshCacheBtn:hover { background: var(--pink-light) !important; }

Â  Â  /* === DASHBOARD === */
Â  Â  .dash-presets {
Â  Â  Â  display: flex; gap: 6px; flex-wrap: wrap;
Â  Â  }
Â  Â  .preset-btn {
Â  Â  Â  border-radius: 20px; padding: 6px 14px;
Â  Â  Â  font-size: 0.78rem; font-weight: 500;
Â  Â  Â  border: 1.5px solid var(--pink-light);
Â  Â  Â  background: white; color: #c49aaa;
Â  Â  Â  cursor: pointer; transition: all 0.2s;
Â  Â  Â  font-family: 'Mitr', sans-serif;
Â  Â  }
Â  Â  .preset-btn:hover, .preset-btn.active {
Â  Â  Â  background: linear-gradient(135deg, var(--pink), #ff6b9d);
Â  Â  Â  color: white; border-color: transparent;
Â  Â  Â  box-shadow: 0 3px 10px rgba(255,143,171,0.35);
Â  Â  }
Â  Â  .dash-datepicker {
Â  Â  Â  display: flex; gap: 8px; align-items: center;
Â  Â  Â  background: var(--card-bg); border-radius: 18px;
Â  Â  Â  padding: 10px 14px;
Â  Â  Â  border: 1.5px solid var(--pink-light);
Â  Â  Â  backdrop-filter: blur(12px);
Â  Â  }
Â  Â  .dash-date-input {
Â  Â  Â  border: 1.5px solid var(--pink-light); border-radius: 12px;
Â  Â  Â  padding: 6px 10px; font-family: 'Mitr', sans-serif;
Â  Â  Â  font-size: 0.82rem; color: var(--text);
Â  Â  Â  flex: 1; min-width: 0; background: white;
Â  Â  }
Â  Â  .dash-search-btn {
Â  Â  Â  border-radius: 12px; padding: 6px 14px;
Â  Â  Â  background: linear-gradient(135deg, var(--pink), #ff6b9d);
Â  Â  Â  border: none; color: white; font-size: 0.9rem;
Â  Â  Â  cursor: pointer; transition: all 0.2s;
Â  Â  Â  box-shadow: 0 3px 10px rgba(255,143,171,0.3);
Â  Â  }
Â  Â  .dash-search-btn:hover { filter: brightness(1.05); transform: scale(1.03); }
Â  Â  .dash-period-badge {
Â  Â  Â  background: linear-gradient(135deg, var(--pink-pale), #f3e8ff);
Â  Â  Â  border: 1.5px solid var(--pink-light);
Â  Â  Â  border-radius: 20px; padding: 5px 16px;
Â  Â  Â  font-size: 0.8rem; color: #b07090;
Â  Â  Â  font-family: 'Mitr', sans-serif;
Â  Â  }
Â  Â  .dash-table-card {
Â  Â  Â  background: var(--card-bg); border-radius: 22px;
Â  Â  Â  padding: 16px; border: 1.5px solid var(--pink-light);
Â  Â  Â  backdrop-filter: blur(12px);
Â  Â  }
Â  Â  .dash-row {
Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  padding: 9px 12px; border-radius: 12px; margin-bottom: 6px;
Â  Â  Â  background: linear-gradient(135deg, #fff0f3, #fff8ff);
Â  Â  Â  border-left: 3px solid var(--pink-light);
Â  Â  Â  font-size: 0.88rem; transition: all 0.2s;
Â  Â  }
Â  Â  .dash-row:hover { border-left-color: var(--pink); transform: translateX(2px); }
Â  Â  .dash-row:nth-child(1) { border-left-color: #FFD700; background: linear-gradient(135deg, #fffde7, #fff8ff); }
Â  Â  .dash-row:nth-child(2) { border-left-color: #b0b8c0; }
Â  Â  .dash-row:nth-child(3) { border-left-color: #cd7f32; }
Â  Â  .dash-rank {
Â  Â  Â  width: 26px; height: 26px; border-radius: 50%;
Â  Â  Â  background: var(--pink-light); color: var(--pink);
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  font-size: 0.75rem; font-weight: 700; flex-shrink: 0;
Â  Â  }
Â  Â  .dash-row:nth-child(1) .dash-rank { background: #FFD700; color: white; }
Â  Â  .dash-row:nth-child(2) .dash-rank { background: #b0b8c0; color: white; }
Â  Â  .dash-row:nth-child(3) .dash-rank { background: #cd7f32; color: white; }
Â  Â  .dash-count {
Â  Â  Â  font-weight: 700; color: var(--pink);
Â  Â  Â  font-size: 1.05rem; flex-shrink: 0;
Â  Â  }
Â  Â  .spinner-ring {
Â  Â  Â  font-size: 2rem;
Â  Â  Â  animation: catBounce 0.8s ease-in-out infinite;
Â  Â  Â  display: inline-block;
Â  Â  }

Â  Â  /* === SWEETALERT THEME === */
Â  Â  .swal-popup {
Â  Â  Â  border-radius: var(--radius) !important;
Â  Â  Â  border: 1.5px solid var(--pink-light) !important;
Â  Â  Â  font-family: 'Mitr', sans-serif !important;
Â  Â  Â  background: #fff0f3 !important;
Â  Â  Â  box-shadow: 0 8px 32px rgba(255,143,171,0.2) !important;
Â  Â  }
Â  Â  .swal-ttl {
Â  Â  Â  font-family: 'Mitr', sans-serif !important;
Â  Â  Â  color: var(--text) !important;
Â  Â  Â  font-size: 1.1rem !important; font-weight: 600 !important;
Â  Â  }
Â  Â  .swal-btn {
Â  Â  Â  border-radius: var(--radius-sm) !important;
Â  Â  Â  font-family: 'Mitr', sans-serif !important;
Â  Â  Â  font-size: 0.92rem !important; font-weight: 600 !important;
Â  Â  Â  padding: 10px 22px !important;
Â  Â  }
Â  Â  .swal2-icon.swal2-warning { border-color: var(--pink) !important; color: var(--pink) !important; }
Â  Â  .swal2-icon.swal2-question { border-color: var(--lilac) !important; color: var(--lilac) !important; }

Â  Â  /* === MARKETPLACE SELECTOR === */
Â  Â  .mp-option {
Â  Â  Â  display: flex; align-items: center; gap: 12px;
Â  Â  Â  padding: 10px 14px;
Â  Â  Â  border-radius: 16px;
Â  Â  Â  border: 2px solid #f0e0e8;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  background: white;
Â  Â  Â  user-select: none;
Â  Â  }
Â  Â  .mp-option:hover { border-color: var(--pink-light); background: var(--pink-pale); }
Â  Â  .mp-option.selected { border-color: var(--pink); background: var(--pink-pale); box-shadow: 0 2px 12px rgba(255,143,171,0.2); }
Â  Â  .mp-radio {
Â  Â  Â  width: 18px; height: 18px; border-radius: 50%;
Â  Â  Â  border: 2px solid #ddd; flex-shrink: 0;
Â  Â  Â  transition: all 0.2s;
Â  Â  Â  background: white;
Â  Â  }
Â  Â  .mp-option.selected .mp-radio {
Â  Â  Â  border-color: var(--pink);
Â  Â  Â  background: var(--pink);
Â  Â  Â  box-shadow: inset 0 0 0 3px white;
Â  Â  }
Â  Â  .mp-icon {
Â  Â  Â  width: 36px; height: 36px; border-radius: 10px;
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  .mp-label { display: flex; flex-direction: column; }
Â  Â  .mp-name { font-weight: 600; font-size: 0.92rem; color: var(--text); }
Â  Â  .mp-desc { font-size: 0.72rem; color: #b0889a; margin-top: 1px; }
Â  Â  .mp-guide-btn {
Â  Â  Â  margin-left: auto; flex-shrink: 0;
Â  Â  Â  font-size: 0.72rem; padding: 4px 10px;
Â  Â  Â  border-radius: 12px; border: 1.5px solid var(--pink-light);
Â  Â  Â  background: white; color: var(--pink);
Â  Â  Â  text-decoration: none; font-family: 'Mitr', sans-serif;
Â  Â  Â  transition: all 0.2s; white-space: nowrap;
Â  Â  Â  display: flex; align-items: center; gap: 4px;
Â  Â  }
Â  Â  .mp-guide-btn:hover { background: var(--pink); color: white; border-color: var(--pink); }
Â  </style>
</head>
<body>
<canvas id="overlayCanvas" style="display:none;"></canvas>

<!-- TOP APP BAR -->
<div id="app-header">
Â  <div class="topbar-logo">ğŸŒ¸</div>
Â  <div style="flex:1; margin-left:10px;">
Â  Â  <div class="topbar-title">Lamsangstore Scanner
Â  Â  Â  <span class="topbar-sub">à¸£à¸°à¸šà¸šà¹à¸à¹‡à¸à¹à¸¥à¸°à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸±à¸ªà¸”à¸¸</span>
Â  Â  </div>
Â  </div>
Â  <button class="btn btn-upload-head" data-bs-toggle="modal" data-bs-target="#uploadModal">ğŸ“¥ à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ</button>
</div>

<!-- BOTTOM NAV -->
<div id="app-tabs">
Â  <button class="tab-btn active" onclick="openTab('scan', this)">
Â  Â  <span class="tab-icon">ğŸ¾</span>à¸ªà¹à¸à¸™
Â  </button>
Â  <button class="tab-btn" onclick="openTab('search', this)">
Â  Â  <span class="tab-icon">ğŸ”</span>à¸„à¹‰à¸™à¸«à¸²
Â  </button>
Â  <button class="tab-btn" onclick="openTab('dash', this)">
Â  Â  <span class="tab-icon">ğŸ€</span>à¸£à¸²à¸¢à¸‡à¸²à¸™
Â  </button>
Â  <button class="tab-btn tab-btn-upload" data-bs-toggle="modal" data-bs-target="#uploadModal">
Â  Â  <span class="tab-icon">ğŸ“¥</span>à¸­à¸±à¸à¹‚à¸«à¸¥à¸”
Â  </button>
</div>

<div class="page-content">

Â  <!-- TAB: SCAN -->
Â  <div id="scan" class="fade-in-up">
Â  Â  <div class="card p-3 text-center">
Â  Â  Â  <div id="rec-ui" class="mb-3 p-2 border rounded-4 bg-light shadow-sm">
Â  Â  Â  Â  <div id="rec-status">
Â  Â  Â  Â  Â  <span id="rec-label" style="color:#c49aaa; font-size:0.95rem; font-weight:500; font-family:'Mitr',sans-serif;">à¸à¸”à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¹€à¸à¸·à¹ˆà¸­à¸ªà¹à¸à¸™à¸à¸±à¸ªà¸”à¸¸</span>
Â  Â  Â  Â  </div>
Â  Â  Â  <div id="rec-ui" style="display:none;">
Â  Â  Â  Â  <div id="rec-status"><span id="rec-label"></span></div>
Â  Â  Â  Â  <video id="video-preview" autoplay playsinline muted></video>
Â  Â  Â  </div>

Â  Â  Â  <button id="startBtn" onclick="initScanner()" class="btn-custom btn-main mb-3 w-100 shadow">à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¸ªà¹à¸à¸™</button>
Â  Â  Â  <button id="refreshCacheBtn" onclick="refreshProductCache()" class="btn btn-outline-secondary btn-sm mb-2" style="display:none; border-radius:15px;">à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²</button>
Â  Â  Â  <div id="reader" style="display:none"></div>

Â  Â  Â  <div id="orderChecklistPanel" class="order-checklist text-start shadow-sm mb-3">
Â  Â  Â  Â  <h6 class="fw-bold mb-2" style="color:var(--text)">à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‡à¸</h6>
Â  Â  Â  Â  <div id="checklistContent"></div>
Â  Â  Â  Â  <div id="orderStatusAlert" class="alert mt-2 mb-0 py-2" style="display:none; font-size: 0.85rem;"></div>

Â  Â  Â  Â  <!-- Remark Panel: à¹à¸ªà¸”à¸‡à¹€à¸¡à¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š -->
Â  Â  Â  Â  <div id="remarkPanel" class="remark-panel">
Â  Â  Â  Â  Â  <p class="mb-2 small fw-bold" style="color:var(--warning);">âš  à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š â€” à¹€à¸¥à¸·à¸­à¸à¹€à¸«à¸•à¸¸à¸œà¸¥</p>
Â  Â  Â  Â  Â  <div id="remarkButtons">
Â  Â  Â  Â  Â  Â  <button class="remark-btn" onclick="selectRemark(this, 'à¸ªà¸´à¸™à¸„à¹‰à¸²à¸«à¸¡à¸”')">ğŸ“¦ à¸ªà¸´à¸™à¸„à¹‰à¸²à¸«à¸¡à¸”</button>
Â  Â  Â  Â  Â  Â  <button class="remark-btn" onclick="selectRemark(this, 'à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸ˆà¹‰à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸µ')">ğŸ¨ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸µ</button>
Â  Â  Â  Â  Â  Â  <button class="remark-btn" onclick="selectRemark(this, 'à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸ˆà¹‰à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸¸à¹ˆà¸™')">ğŸ”„ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸¸à¹ˆà¸™</button>
Â  Â  Â  Â  Â  Â  <button class="remark-btn" onclick="selectRemark(this, 'à¸­à¸·à¹ˆà¸™à¹†')">âœï¸ à¸­à¸·à¹ˆà¸™à¹†</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="remarkOtherBox" style="display:none; margin-top:8px;">
Â  Â  Â  Â  Â  Â  <input id="remarkOtherInput" class="form-control form-control-sm" placeholder="à¸£à¸°à¸šà¸¸à¹€à¸«à¸•à¸¸à¸œà¸¥..." style="border-radius:10px;">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button onclick="confirmRemarkAndFinish()" class="btn btn-warning btn-sm mt-2 w-100 fw-bold" style="border-radius:15px;">
Â  Â  Â  Â  Â  Â  à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸£à¹‰à¸­à¸¡à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¹à¸¥à¸°à¸ˆà¸šà¸‡à¸²à¸™
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="parcel-box mt-3">
Â  Â  Â  Â  <div class="row align-items-center">
Â  Â  Â  Â  Â  <div class="col-7 text-start" style="border-right: 1.5px solid var(--pink-light);">
Â  Â  Â  Â  Â  Â  <div class="section-title" style="margin-top:0; margin-bottom:4px;">à¸à¸±à¸ªà¸”à¸¸à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™</div>
Â  Â  Â  Â  Â  Â  <div class="d-flex align-items-center">
Â  Â  Â  Â  Â  Â  Â  <span id="parcelId" style="font-weight:600; color:var(--pink); font-size:1.1rem;">-</span>
Â  Â  Â  Â  Â  Â  Â  <button id="editParcelBtn" onclick="editParcelId()" class="btn btn-edit-inline" style="display:none">âœï¸</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="col-5 text-center">
Â  Â  Â  Â  Â  Â  <div class="section-title" style="margin-top:0; margin-bottom:4px;">à¸ˆà¸³à¸™à¸§à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²</div>
Â  Â  Â  Â  Â  Â  <div id="count" style="font-size:2.2rem; font-weight:600; color:var(--pink);">0</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="statusLabel" class="status-badge bg-light text-muted">à¸£à¸­à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸š...</div>

Â  Â  Â  <div class="mt-3 text-start">
Â  Â  Â  Â  <div class="section-title">à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡</div>
Â  Â  Â  Â  <ul id="itemList" class="list-group"></ul>
Â  Â  Â  </div>

Â  Â  Â  <button id="refreshCacheBtn" onclick="refreshProductCache()" class="btn btn-sm mb-2 w-100" style="display:none; border-radius:18px; border:1.5px solid var(--pink-light); color:var(--pink); background:white; font-family:'Mitr',sans-serif; font-size:0.88rem; padding:8px;">ğŸ”„ à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²</button>

Â  Â  Â  <div id="action-buttons" class="mt-4" style="display:none">
Â  Â  Â  Â  <div class="row g-2">
Â  Â  Â  Â  Â  <div class="col-8">
Â  Â  Â  Â  Â  Â  <button id="saveBtn" onclick="finishWork(true)" class="btn-custom btn-save w-100">à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¸°à¸ˆà¸šà¸‡à¸²à¸™</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="col-4">
Â  Â  Â  Â  Â  Â  <button id="cancelBtn" onclick="cancelWork()" class="btn-custom btn-cancel w-100">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div><!-- /scan -->

Â  <!-- TAB: SEARCH -->
Â  <div id="search" style="display:none" class="fade-in-up">
Â  Â  <div class="card p-3">
Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  <div id="search-reader" style="display:none; margin-bottom: 15px;"></div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <input id="searchInput" class="form-control rounded-start-4 p-3" placeholder="à¸à¸´à¸¡à¸à¹Œà¸«à¸£à¸·à¸­à¸ªà¹à¸à¸™à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸..." onkeypress="handleEnter(event)">
Â  Â  Â  Â  Â  <button class="btn btn-primary px-3" onclick="startSearchScan()" title="à¸ªà¹à¸à¸™à¸”à¹‰à¸§à¸¢à¸à¸¥à¹‰à¸­à¸‡">ğŸ“·</button>
Â  Â  Â  Â  Â  <button class="btn btn-success rounded-end-4 px-4" onclick="runSearch()">à¸„à¹‰à¸™à¸«à¸²</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-text text-muted ms-2 small">ğŸ’¡ à¸„à¹‰à¸™à¸«à¸²à¹„à¸”à¹‰à¸—à¸±à¹‰à¸‡à¸•à¸±à¸§à¸à¸´à¸¡à¸à¹Œà¹€à¸¥à¹‡à¸à¹à¸¥à¸°à¹ƒà¸«à¸à¹ˆ</div>
Â  Â  Â  </div>
Â  Â  Â  <div id="loadingSearch" class="text-center my-3" style="display:none">
Â  Â  Â  Â  <div class="spinner-border text-primary"></div>
Â  Â  Â  Â  <p class="small text-muted mt-2">à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²...</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  <table class="table table-hover small">
Â  Â  Â  Â  Â  <thead id="tableHead" class="table-light"></thead>
Â  Â  Â  Â  Â  <tbody id="resultBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <!-- TAB: DASHBOARD -->
Â  <div id="dash" style="display:none" class="fade-in-up">

Â  Â  <!-- Date Preset Buttons -->
Â  Â  <div class="dash-presets mb-3">
Â  Â  Â  <button class="preset-btn active" onclick="setPreset('today',this)">à¸§à¸±à¸™à¸™à¸µà¹‰</button>
Â  Â  Â  <button class="preset-btn" onclick="setPreset('yesterday',this)">à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™</button>
Â  Â  Â  <button class="preset-btn" onclick="setPreset('last7',this)">7 à¸§à¸±à¸™</button>
Â  Â  Â  <button class="preset-btn" onclick="setPreset('thisMonth',this)">à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰</button>
Â  Â  Â  <button class="preset-btn" onclick="setPreset('lastMonth',this)">à¹€à¸”à¸·à¸­à¸™à¸à¹ˆà¸­à¸™</button>
Â  Â  </div>

Â  Â  <!-- Date Range Picker -->
Â  Â  <div class="dash-datepicker mb-3">
Â  Â  Â  <input type="date" id="dashStart" class="dash-date-input">
Â  Â  Â  <span style="color:#c49aaa; font-size:0.85rem;">à¸–à¸¶à¸‡</span>
Â  Â  Â  <input type="date" id="dashEnd" class="dash-date-input">
Â  Â  Â  <button onclick="fetchReport()" class="dash-search-btn">ğŸ”</button>
Â  Â  </div>

Â  Â  <!-- Loading -->
Â  Â  <div id="dashLoading" style="display:none; text-align:center; padding:20px;">
Â  Â  Â  <div style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--text);border-radius:50%;animation:spin 0.7s linear infinite;margin:0 auto 8px;"></div>
Â  Â  Â  <div style="font-size:0.78rem;color:var(--text3);">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
Â  Â  </div>

Â  Â  <!-- Report Content -->
Â  Â  <div id="dashContent" style="display:none;">
Â  Â  Â  <div class="text-center mb-3">
Â  Â  Â  Â  <span class="dash-period-badge" id="dashPeriod">-</span>
Â  Â  Â  </div>

Â  Â  Â  <!-- Summary Cards -->
Â  Â  Â  <div class="row g-2 mb-3">
Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  <div style="font-size:1.8rem;">ğŸ“¦</div>
Â  Â  Â  Â  Â  Â  <div class="small mb-1" style="color:#c49aaa;">à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ (à¹à¸à¹‡à¸„)</div>
Â  Â  Â  Â  Â  Â  <div id="d-box" class="stat-num">0</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  <div style="font-size:1.8rem;">ğŸ€</div>
Â  Â  Â  Â  Â  Â  <div class="small mb-1" style="color:#c49aaa;">à¸ªà¸´à¸™à¸„à¹‰à¸² (à¸Šà¸´à¹‰à¸™)</div>
Â  Â  Â  Â  Â  Â  <div id="d-item" class="stat-num">0</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <!-- Top Products Table -->
Â  Â  Â  <div class="dash-table-card">
Â  Â  Â  Â  <h6 class="fw-bold mb-3" style="color:var(--pink);">ğŸ† à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ</h6>
Â  Â  Â  Â  <div id="dashProductTable">
Â  Â  Â  Â  Â  <div class="text-center text-muted small py-3">à¸à¸”à¸„à¹‰à¸™à¸«à¸²à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¹ˆà¸° ğŸ±</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Reset button -->
Â  Â  <div class="text-center mt-3">
Â  Â  Â  <button class="btn btn-sm" onclick="resetSession()"
Â  Â  Â  Â  style="border-radius:var(--radius-sm); border:1.5px solid var(--pink-light); color:var(--pink); background:white; font-family:Mitr,sans-serif; font-size:0.88rem; padding:8px 20px;">
Â  Â  Â  Â  à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸´à¸•à¸´
Â  Â  Â  </button>
Â  Â  </div>
Â  </div>
</div><!-- /page-content -->

<!-- Modal à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
Â  <div class="modal-dialog">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h5 class="modal-title text-white">ğŸ›ï¸ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­</h5>
Â  Â  Â  Â  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-body px-4 py-3">

Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  <label class="form-label fw-600 small mb-2" style="color:var(--brown);">à¹€à¸¥à¸·à¸­à¸à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡ (Marketplace)</label>
Â  Â  Â  Â  Â  <!-- Custom marketplace selector -->
Â  Â  Â  Â  Â  <div id="mpSelector" style="display:flex; flex-direction:column; gap:8px;">

Â  Â  Â  Â  Â  Â  <label class="mp-option" data-value="tiktok" onclick="selectMarketplace('tiktok', this)">
Â  Â  Â  Â  Â  Â  Â  <div class="mp-radio"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-icon" style="background:#010101;">
Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.69a8.18 8.18 0 004.78 1.52V6.74a4.85 4.85 0 01-1.01-.05z"/></svg>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-label">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-name">TikTok Shop</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-desc">Tracking=AJ Â· SKU=G Â· Qty=J</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <a href="TTindex.html" target="_blank" class="mp-guide-btn" onclick="event.stopPropagation()">ğŸ“– à¸„à¸¹à¹ˆà¸¡à¸·à¸­</a>
Â  Â  Â  Â  Â  Â  </label>

Â  Â  Â  Â  Â  Â  <label class="mp-option" data-value="shopee" onclick="selectMarketplace('shopee', this)">
Â  Â  Â  Â  Â  Â  Â  <div class="mp-radio"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-icon" style="background:#ee4d2d;">
Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M12 2C9.2 2 7 4.2 7 7H5c-.6 0-1 .4-1.1.9L2.5 19.9c-.1.6.4 1.1 1 1.1h17c.6 0 1.1-.5 1-1.1l-1.4-12C19.9 7.4 19.5 7 19 7h-2c0-2.8-2.2-5-5-5zm0 2c1.7 0 3 1.3 3 3H9c0-1.7 1.3-3 3-3zm0 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-label">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-name">Shopee</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-desc">Tracking=N Â· SKU=S Â· Qty=W</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <a href="SPindex.html" target="_blank" class="mp-guide-btn" onclick="event.stopPropagation()">ğŸ“– à¸„à¸¹à¹ˆà¸¡à¸·à¸­</a>
Â  Â  Â  Â  Â  Â  </label>

Â  Â  Â  Â  Â  Â  <label class="mp-option" data-value="lazada" onclick="selectMarketplace('lazada', this)">
Â  Â  Â  Â  Â  Â  Â  <div class="mp-radio"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-icon" style="background:#0f146d;">
Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M4 4h16v2H4zm0 5h10v2H4zm0 5h16v2H4zm0 5h10v2H4z"/></svg>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-label">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-name">Lazada</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-desc">Tracking=BG Â· SKU=F Â· (1 row = 1 à¸Šà¸´à¹‰à¸™)</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <a href="LZindex.html" target="_blank" class="mp-guide-btn" onclick="event.stopPropagation()">ğŸ“– à¸„à¸¹à¹ˆà¸¡à¸·à¸­</a>
Â  Â  Â  Â  Â  Â  </label>

Â  Â  Â  Â  Â  Â  <label class="mp-option" data-value="page365" onclick="selectMarketplace('page365', this)">
Â  Â  Â  Â  Â  Â  Â  <div class="mp-radio"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-icon" style="background:#1877f2;">
Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12c0 4.99 3.66 9.12 8.44 9.88v-6.99H7.9V12h2.54V9.8c0-2.51 1.49-3.89 3.78-3.89 1.09 0 2.24.19 2.24.19v2.46h-1.26c-1.24 0-1.63.77-1.63 1.56V12h2.77l-.44 2.89h-2.33v6.99C18.34 21.12 22 17 22 12c0-5.52-4.48-10-10-10z"/></svg>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="mp-label">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-name">Page365</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="mp-desc">Tracking=L Â· SKU=Y Â· Qty=AC</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <a href="365index.html" target="_blank" class="mp-guide-btn" onclick="event.stopPropagation()">ğŸ“– à¸„à¸¹à¹ˆà¸¡à¸·à¸­</a>
Â  Â  Â  Â  Â  Â  </label>

Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <!-- hidden select à¸ªà¸³à¸«à¸£à¸±à¸š JS -->
Â  Â  Â  Â  Â  <select id="marketplaceSelect" style="display:none;">
Â  Â  Â  Â  Â  Â  <option value="tiktok">tiktok</option>
Â  Â  Â  Â  Â  Â  <option value="shopee">shopee</option>
Â  Â  Â  Â  Â  Â  <option value="lazada">lazada</option>
Â  Â  Â  Â  Â  Â  <option value="page365">page365</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mb-2">
Â  Â  Â  Â  Â  <label class="form-label fw-600 small mb-2" style="color:var(--brown);">à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ (.xlsx, .csv)</label>
Â  Â  Â  Â  Â  <input type="file" id="fileInput" class="form-control" style="border-radius:14px; border:1.5px solid var(--pink-light);" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="modal-footer" style="border-top:1.5px solid var(--pink-light); padding:14px 20px; gap:10px;">
Â  Â  Â  Â  <button type="button" class="btn" style="border-radius:16px; border:1.5px solid #ddd; color:#888; font-family:'Mitr',sans-serif; padding:10px 22px;" data-bs-dismiss="modal">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  <button type="button" onclick="processFileUpload()" style="border-radius:16px; background:linear-gradient(135deg,var(--pink),#e84393); color:white; border:none; font-family:'Mitr',sans-serif; font-weight:600; padding:10px 28px; box-shadow:0 4px 14px rgba(255,143,171,0.4); font-size:0.95rem;">
Â  Â  Â  Â  Â  ğŸ“¤ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ============================================================
// âš™ï¸ CONFIG: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸„à¹ˆà¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰à¸šà¸£à¸£à¸—à¸±à¸”à¹€à¸”à¸µà¸¢à¸§!
// ============================================================
const GAS_URL = "https://script.google.com/macros/s/AKfycby1689Y6ybjRtRB-nvG6SvQlP-jIVn5rpPttl9hSzD0VRyyEdsgHPrHLfIs2q8h612-Qg/exec";
// ============================================================

// --- Hash Routing ---
function navigateByHash() {
Â  const hash = window.location.hash;
Â  if (!hash || hash === '#scan') return;

Â  // à¹à¸ªà¸”à¸‡ tab bar à¸à¹ˆà¸­à¸™à¹€à¸¥à¸¢ (à¹ƒà¸™à¸à¸£à¸“à¸µà¸—à¸µà¹ˆà¸¢à¸±à¸‡à¸‹à¹ˆà¸­à¸™à¸­à¸¢à¸¹à¹ˆ)
Â  const appTabs = document.getElementById('app-tabs');
Â  if (appTabs) appTabs.style.display = 'flex';

Â  if (hash === '#report' || hash === '#dash') {
Â  Â  const btn = document.querySelectorAll('.tab-btn')[2];
Â  Â  openTab('dash', btn);
Â  } else if (hash === '#search') {
Â  Â  const btn = document.querySelectorAll('.tab-btn')[1];
Â  Â  openTab('search', btn);
Â  }
}

window.addEventListener('hashchange', navigateByHash);

// à¸£à¸­ page à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œà¸à¹ˆà¸­à¸™à¸„à¹ˆà¸­à¸¢ navigate
window.addEventListener('load', () => {
Â  setTimeout(navigateByHash, 100);
});

// --- Marketplace Selector ---
function selectMarketplace(value, el) {
Â  document.querySelectorAll('.mp-option').forEach(o => o.classList.remove('selected'));
Â  el.classList.add('selected');
Â  document.getElementById('marketplaceSelect').value = value;
}
// à¹€à¸¥à¸·à¸­à¸ TikTok à¹€à¸›à¹‡à¸™ default
document.addEventListener('DOMContentLoaded', () => {
Â  const first = document.querySelector('.mp-option');
Â  if (first) first.classList.add('selected');
});

// col index = à¹€à¸¥à¸‚ column - 1 (à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸²à¸ 0)
const colMappings = {
Â  'tiktok':Â  { tracking: 35, sku: 6,Â  qty: 9,Â  headerRows: 1 }, // AJ=36, G=7, J=10
Â  'shopee':Â  { tracking: 13, sku: 18, qty: 22, headerRows: 1 }, // N=14, S=19, W=23
Â  'lazada':Â  { tracking: 58, sku: 5,Â  qty: -1, headerRows: 1 }, // BG=59, F=6, à¹„à¸¡à¹ˆà¸¡à¸µ qty (1row=1à¸Šà¸´à¹‰à¸™)
Â  'page365': { tracking: 11, sku: 24, qty: 28, headerRows: 1, isCsv: true } // L=12, Y=25, AC=29
};

// --- à¸•à¸±à¸§à¹à¸›à¸£à¸«à¸¥à¸±à¸ ---
let productMap = {}, currentP = "", items = [], scanner, searchScanner, lastScanTime = 0;
let sessionParcels = {}, scanBuffer = [], bufferTimeout = null, isFinishing = false, isEditingId = false;
let expectedItemsArray = [], scannedItemsMap = {}, isStrictValidationMode = false;
let currentRemark = ''; // à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¹€à¸¡à¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š
let mediaRecorder, recordedChunks = [], cameraStream = null, isRecording = false;

// --- API Helper: à¹à¸—à¸™à¸—à¸µà¹ˆ google.script.run à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” ---
async function callGAS(action, payload = {}) {
Â  const res = await fetch(GAS_URL, {
Â  Â  method: "POST",
Â  Â  headers: { "Content-Type": "text/plain" },
Â  Â  body: JSON.stringify({ action, ...payload })
Â  });
Â  const text = await res.text();
Â  try { return JSON.parse(text); } catch { return text; }
}

// --- Speech ---
function speak(t, priority = true) {
Â  if (!window.speechSynthesis) return;
Â  if (priority) speechSynthesis.cancel();
Â  const m = new SpeechSynthesisUtterance(t);
Â  m.lang = "th-TH"; m.rate = 1.3;
Â  speechSynthesis.speak(m);
}

// --- à¸à¸¥à¹‰à¸­à¸‡à¹à¸¥à¸°à¸§à¸´à¸”à¸µà¹‚à¸­ ---
async function startCameraRecording() {
Â  if (isRecording) return;
Â  const videoEl = document.getElementById('video-preview');
Â  const canvas = document.getElementById('overlayCanvas');
Â  const ctx = canvas.getContext('2d');
Â  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
Â  try {
Â  Â  cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
Â  Â  videoEl.srcObject = cameraStream;
Â  Â  await videoEl.play();
Â  Â  canvas.width = videoEl.videoWidth || 640;
Â  Â  canvas.height = videoEl.videoHeight || 480;
Â  Â  recordedChunks = [];

Â  Â  function drawOverlay() {
Â  Â  Â  if (!isRecording && !cameraStream) return;
Â  Â  Â  ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
Â  Â  Â  const overlayHeight = 160 + items.length * 26;
Â  Â  Â  ctx.fillStyle = "rgba(0,0,0,0.55)";
Â  Â  Â  ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, overlayHeight);
Â  Â  Â  ctx.fillStyle = "#ffffff";
Â  Â  Â  ctx.font = "22px sans-serif";
Â  Â  Â  const now = new Date().toLocaleString("th-TH");
Â  Â  Â  let y = canvas.height - overlayHeight + 30;
Â  Â  Â  ctx.fillText("ğŸ“… " + now, 20, y); y += 30;
Â  Â  Â  ctx.fillText("ğŸ“¦ à¸à¸±à¸ªà¸”à¸¸: " + (currentP || "-"), 20, y); y += 30;
Â  Â  Â  ctx.fillText("ğŸ§¾ à¸ˆà¸³à¸™à¸§à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²: " + items.length + " à¸Šà¸´à¹‰à¸™", 20, y);
Â  Â  Â  ctx.font = "20px sans-serif";
Â  Â  Â  items.forEach(sku => { y += 26; ctx.fillText("- " + (productMap[sku] || sku), 40, y); });
Â  Â  Â  requestAnimationFrame(drawOverlay);
Â  Â  }
Â  Â  drawOverlay();

Â  Â  const canvasStream = canvas.captureStream(30);
Â  Â  mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 2500000 });
Â  Â  mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
Â  Â  mediaRecorder.start();
Â  Â  isRecording = true;
Â  Â  document.getElementById('rec-label').innerHTML = '<div class="rec-indicator"><span class="rec-dot"></span> à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸§à¸´à¸”à¸µà¹‚à¸­à¸à¸£à¹‰à¸­à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸³à¸à¸±à¸š</div>';
Â  } catch (err) {
Â  Â  console.error("Camera error:", err);
Â  Â  document.getElementById('rec-label').innerText = "âš ï¸ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¹„à¸”à¹‰: " + err.message;
Â  }
}

function stopCameraRecording() {
Â  return new Promise((resolve) => {
Â  Â  if (!mediaRecorder || mediaRecorder.state === "inactive") {
Â  Â  Â  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
Â  Â  Â  resolve([]); return;
Â  Â  }
Â  Â  mediaRecorder.addEventListener('stop', () => {
Â  Â  Â  isRecording = false;
Â  Â  Â  const snapshot = [...recordedChunks];
Â  Â  Â  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
Â  Â  Â  document.getElementById('rec-label').innerText = "ğŸ”´ à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§";
Â  Â  Â  resolve(snapshot);
Â  Â  }, { once: true });
Â  Â  mediaRecorder.stop();
Â  });
}

async function convertChunksToBase64(chunks) {
Â  if (!chunks || chunks.length === 0) return "";
Â  const blob = new Blob(chunks, { type: 'video/webm' });
Â  return new Promise((resolve) => {
Â  Â  const reader = new FileReader();
Â  Â  reader.onloadend = () => {
Â  Â  Â  if (!reader.result || typeof reader.result !== 'string') { resolve(""); return; }
Â  Â  Â  const idx = reader.result.indexOf(',');
Â  Â  Â  resolve(idx > -1 ? reader.result.slice(idx + 1) : "");
Â  Â  };
Â  Â  reader.onerror = () => resolve("");
Â  Â  reader.readAsDataURL(blob);
Â  });
}

// --- à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸š ---
async function initScanner() {
Â  const btn = document.getElementById("startBtn");
Â  const CACHE_KEY = "productMap_cache";
Â  const CACHE_TIME_KEY = "productMap_time";
Â  const CACHE_TTL = 60 * 60 * 1000; // 1 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡

Â  // à¹‚à¸«à¸¥à¸” cache à¸à¹ˆà¸­à¸™à¹€à¸¥à¸¢ â€” à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¹„à¸”à¹‰à¸—à¸±à¸™à¸—à¸µà¹„à¸¡à¹ˆà¸£à¸­ GAS
Â  const cached = localStorage.getItem(CACHE_KEY);
Â  const cachedTime = parseInt(localStorage.getItem(CACHE_TIME_KEY) || "0");
Â  const isFresh = (Date.now() - cachedTime) < CACHE_TTL;

Â  if (cached) {
Â  Â  productMap = JSON.parse(cached);
Â  Â  document.getElementById("app-header").style.display = "none";
Â  Â  document.getElementById("app-tabs").style.display = "none";
Â  Â  btn.style.display = "none";
Â  Â  document.getElementById("action-buttons").style.display = "block";
Â  Â  document.getElementById("refreshCacheBtn").style.display = "inline-block";
Â  Â  speak("à¸£à¸°à¸šà¸šà¸à¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸° à¹€à¸£à¸´à¹ˆà¸¡à¸ªà¹à¸à¸™à¸à¸±à¸ªà¸”à¸¸à¹„à¸”à¹‰à¹€à¸¥à¸¢");
Â  Â  startScan();

Â  Â  // refresh à¹€à¸šà¸·à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡à¸–à¹‰à¸² cache à¹€à¸à¹ˆà¸²à¹€à¸à¸´à¸™ 1 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡
Â  Â  if (!isFresh) {
Â  Â  Â  callGAS("getProductData").then(res => {
Â  Â  Â  Â  if (res && Object.keys(res).length > 0) {
Â  Â  Â  Â  Â  productMap = res;
Â  Â  Â  Â  Â  localStorage.setItem(CACHE_KEY, JSON.stringify(res));
Â  Â  Â  Â  Â  localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
Â  Â  Â  Â  Â  console.log("[Cache] à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸¥à¹‰à¸§");
Â  Â  Â  Â  }
Â  Â  Â  }).catch(() => {});
Â  Â  }
Â  Â  return;
Â  }

Â  // à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ cache â€” à¹‚à¸«à¸¥à¸”à¸›à¸à¸•à¸´
Â  btn.innerText = "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...";
Â  btn.disabled = true;
Â  try {
Â  Â  const res = await callGAS("getProductData");
Â  Â  productMap = res || {};
Â  Â  // à¹€à¸à¹‡à¸š cache
Â  Â  localStorage.setItem(CACHE_KEY, JSON.stringify(productMap));
Â  Â  localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
Â  Â  document.getElementById("app-header").style.display = "none";
Â  Â  document.getElementById("app-tabs").style.display = "none";
Â  Â  btn.style.display = "none";
Â  Â  document.getElementById("action-buttons").style.display = "block";
Â  Â  document.getElementById("refreshCacheBtn").style.display = "inline-block";
Â  Â  speak("à¸£à¸°à¸šà¸šà¸à¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸° à¹€à¸£à¸´à¹ˆà¸¡à¸ªà¹à¸à¸™à¸à¸±à¸ªà¸”à¸¸à¹„à¸”à¹‰à¹€à¸¥à¸¢");
Â  Â  startScan();
Â  } catch (err) {
Â  Â  btn.innerText = "à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ â€” à¸à¸”à¹€à¸à¸·à¹ˆà¸­à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ";
Â  Â  btn.disabled = false;
Â  Â  Swal.fire('à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', 'à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š GAS_URL à¹ƒà¸™ index.html\n\n' + err.message, 'error');
Â  }
}

async function refreshProductCache() {
Â  const btn = document.getElementById("refreshCacheBtn");
Â  btn.innerText = "â³ à¸à¸³à¸¥à¸±à¸‡à¸£à¸µà¹€à¸Ÿà¸£à¸Š...";
Â  btn.disabled = true;
Â  try {
Â  Â  const res = await callGAS("getProductData");
Â  Â  if (res && Object.keys(res).length > 0) {
Â  Â  Â  productMap = res;
Â  Â  Â  localStorage.setItem("productMap_cache", JSON.stringify(res));
Â  Â  Â  localStorage.setItem("productMap_time", Date.now().toString());
Â  Â  Â  btn.innerText = "âœ… à¸­à¸±à¸›à¹€à¸”à¸•à¹à¸¥à¹‰à¸§";
Â  Â  Â  setTimeout(() => { btn.innerText = "ğŸ”„ à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²"; btn.disabled = false; }, 2000);
Â  Â  }
Â  } catch (e) {
Â  Â  btn.innerText = "âŒ à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ";
Â  Â  btn.disabled = false;
Â  }
}

function startScan() {
Â  document.getElementById("reader").style.display = "block";
Â  if (!scanner) {
Â  Â  scanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: { width: 300, height: 350 }, rememberLastUsedCamera: true });
Â  Â  scanner.render((text, result) => onScanBuffer(text, result));
Â  }
}

function onScanBuffer(text, result) {
Â  const now = Date.now();
Â  if (isFinishing || now - lastScanTime < 2500) return;
Â  let yPos = 9999;
Â  if (result && result.result && result.result.location) yPos = result.result.location.topLeftCorner.y;
Â  scanBuffer.push({ text, y: yPos });
Â  if (!bufferTimeout) {
Â  Â  bufferTimeout = setTimeout(() => {
Â  Â  Â  scanBuffer.sort((a, b) => a.y - b.y);
Â  Â  Â  processFinalScan(scanBuffer[0].text);
Â  Â  Â  scanBuffer = []; bufferTimeout = null;
Â  Â  }, 300);
Â  }
}

async function processFinalScan(text) {
Â  const upperText = text.trim().toUpperCase();
Â  const isFlash = upperText.startsWith("TH") && (upperText.length === 15 || upperText.length === 14);
Â  const isJT = /^\d{12}$/.test(upperText) || /^(81|82|83|86|JET)/.test(upperText);
Â  const isProduct = upperText.startsWith("B");

Â  if (isProduct) {
Â  Â  if (!currentP && !isEditingId) { speak("à¸à¸£à¸¸à¸“à¸²à¸ªà¹à¸à¸™à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸à¸à¹ˆà¸­à¸™à¸™à¸°à¸„à¸°"); return; }
Â  Â  if (isStrictValidationMode) {
Â  Â  Â  let reqItem = expectedItemsArray.find(i => i.sku === upperText);
Â  Â  Â  let currentScannedQty = scannedItemsMap[upperText] || 0;
Â  Â  Â  const productName = productMap[upperText] || upperText;
Â  Â  Â  if (!reqItem) {
Â  Â  Â  Â  // à¸à¸¹à¸”à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¸•à¸²à¸¡à¸”à¹‰à¸§à¸¢à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™
Â  Â  Â  Â  speak(productName, true);
Â  Â  Â  Â  setTimeout(() => speak("à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¸™à¸µà¹‰à¹ƒà¸™à¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸°à¸„à¸°", false), 800);
Â  Â  Â  } else if (currentScannedQty >= reqItem.qty) {
Â  Â  Â  Â  speak(productName, true);
Â  Â  Â  Â  setTimeout(() => speak("à¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸à¸´à¸™à¸ˆà¸³à¸™à¸§à¸™à¸„à¹ˆà¸°", false), 800);
Â  Â  Â  } else {
Â  Â  Â  Â  speak(productName, true);
Â  Â  Â  }
Â  Â  Â  scannedItemsMap[upperText] = currentScannedQty + 1;
Â  Â  } else {
Â  Â  Â  speak(productMap[upperText] || upperText, true);
Â  Â  }
Â  Â  lastScanTime = Date.now();
Â  Â  items.push(upperText);
Â  Â  document.getElementById("count").innerText = items.length;
Â  Â  renderList();
Â  Â  if (isStrictValidationMode) updateChecklistUI();
Â  Â  setStatus("âœ” à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸´à¸™à¸„à¹‰à¸²: " + upperText, "success");
Â  } else if (isFlash || isJT) {
Â  Â  lastScanTime = Date.now();
Â  Â  const carrier = isFlash ? "à¹à¸Ÿà¸¥à¸Š" : "à¹€à¸ˆ à¹à¸­à¸™à¸”à¹Œ à¸—à¸µ";
Â  Â  if (sessionParcels[upperText] && !isEditingId) {
Â  Â  Â  speak("à¸à¸±à¸ªà¸”à¸¸à¹ƒà¸šà¸™à¸µà¹‰à¸ªà¹à¸à¸™à¸›à¸´à¸”à¸‡à¸²à¸™à¹„à¸›à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°");
Â  Â  Â  setStatus("âŒ à¸à¸±à¸ªà¸”à¸¸ " + upperText + " à¸›à¸´à¸”à¸‡à¸²à¸™à¹„à¸›à¹à¸¥à¹‰à¸§", "danger"); return;
Â  Â  }
Â  Â  if (upperText === currentP && !isEditingId) {
Â  Â  Â  if (items.length === 0) { speak("à¸à¸¥à¹ˆà¸­à¸‡à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¸„à¹ˆà¸°"); setStatus("âš ï¸ à¸à¸¥à¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡", "warning"); return; }
Â  Â  Â  // à¸–à¹‰à¸²à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ strict mode à¹à¸¥à¸°à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š â€” à¹„à¸¡à¹ˆà¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¸›à¸´à¸”à¸‡à¸²à¸™à¸”à¹‰à¸§à¸¢à¸à¸²à¸£à¸ªà¹à¸à¸™
Â  Â  Â  if (isStrictValidationMode && !validateCurrentOrder()) {
Â  Â  Â  Â  let hasOver = false;
Â  Â  Â  Â  for (let sSku in scannedItemsMap) {
Â  Â  Â  Â  Â  const req = expectedItemsArray.find(ex => ex.sku === sSku);
Â  Â  Â  Â  Â  if (!req || scannedItemsMap[sSku] > req.qty) { hasOver = true; break; }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (hasOver) {
Â  Â  Â  Â  Â  speak("à¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸à¸´à¸™à¸ˆà¸³à¸™à¸§à¸™à¸„à¹ˆà¸° à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š");
Â  Â  Â  Â  Â  setStatus("âŒ à¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸à¸´à¸™à¸ˆà¸³à¸™à¸§à¸™", "danger"); return;
Â  Â  Â  Â  }
Â  Â  Â  Â  // à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š â€” à¹à¸ªà¸”à¸‡ remark panel à¹ƒà¸«à¹‰à¸à¸”à¸—à¸µà¹ˆà¸«à¸™à¹‰à¸²à¸ˆà¸­
Â  Â  Â  Â  speak("à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸šà¸„à¹ˆà¸° à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹€à¸«à¸•à¸¸à¸œà¸¥à¸šà¸™à¸«à¸™à¹‰à¸²à¸ˆà¸­", false);
Â  Â  Â  Â  document.getElementById('remarkPanel').style.display = 'block';
Â  Â  Â  Â  document.getElementById('orderChecklistPanel').scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  setStatus("âš ï¸ à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹€à¸«à¸•à¸¸à¸œà¸¥", "warning"); return;
Â  Â  Â  }
Â  Â  Â  speak("à¸ªà¹à¸à¸™à¸›à¸´à¸”à¸‡à¸²à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸„à¹ˆà¸° à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸šà¸šà¹€à¸šà¸·à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡");
Â  Â  Â  finishWork(false); return;
Â  Â  }
Â  Â  if (currentP && upperText !== currentP && !isEditingId) {
Â  Â  Â  speak("à¸à¸£à¸¸à¸“à¸²à¸ªà¹à¸à¸™à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸à¹€à¸”à¸´à¸¡à¹€à¸à¸·à¹ˆà¸­à¸›à¸´à¸”à¸‡à¸²à¸™à¸à¹ˆà¸­à¸™à¸„à¹ˆà¸°");
Â  Â  Â  setStatus("âŒ à¸•à¹‰à¸­à¸‡à¸ªà¹à¸à¸™à¸›à¸´à¸”à¸‡à¸²à¸™à¹ƒà¸šà¹€à¸”à¸´à¸¡à¸à¹ˆà¸­à¸™", "danger"); return;
Â  Â  }
Â  Â  processNewParcel(upperText, carrier);
Â  } else {
Â  Â  lastScanTime = Date.now();
Â  Â  speak("à¸£à¸¹à¸›à¹à¸šà¸šà¸£à¸«à¸±à¸ªà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°");
Â  Â  setStatus("âš ï¸ à¸£à¸¹à¸›à¹à¸šà¸šà¸£à¸«à¸±à¸ªà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡", "warning");
Â  }
}

function setStatus(msg, type) {
Â  const el = document.getElementById("statusLabel");
Â  el.innerText = msg;
Â  const map = { success: "bg-success text-white", danger: "bg-danger text-white", warning: "bg-warning text-dark", primary: "bg-primary text-white", info: "bg-info text-white" };
Â  el.className = "status-badge " + (map[type] || "bg-light text-muted");
}

function editParcelId() {
Â  speak("à¹€à¸•à¸£à¸µà¸¢à¸¡à¸ªà¹à¸à¸™à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸™à¸°à¸„à¸°");
Â  isEditingId = true; currentP = "";
Â  document.getElementById("parcelId").innerText = "à¸£à¸­à¸ªà¹à¸à¸™à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ...";
Â  setStatus("âœï¸ à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‰à¹„à¸‚à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸...", "info");
Â  document.getElementById("editParcelBtn").style.display = "none";
}

function processNewParcel(text, carrier) {
Â  const wasEditing = isEditingId;
Â  currentP = text;
Â  if (!wasEditing) items = [];
Â  isEditingId = false;
Â  document.getElementById("parcelId").innerText = text;
Â  document.getElementById("count").innerText = items.length;
Â  renderList();
Â  setStatus((wasEditing ? "âœï¸ à¹à¸à¹‰à¹„à¸‚à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸à¹€à¸›à¹‡à¸™: " : `ğŸ“¦ à¸à¸±à¸ªà¸”à¸¸ ${carrier}: `) + text, "primary");
Â  document.getElementById("editParcelBtn").style.display = "inline-block";
Â  const lastFour = text.length >= 4 ? text.slice(-4) : text;
Â  if (wasEditing) {
Â  Â  speak(`à¹à¸à¹‰à¹„à¸‚à¹€à¸›à¹‡à¸™à¸£à¸«à¸±à¸ª ${lastFour.split('').join(' ')} à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸„à¹ˆà¸°`);
Â  Â  // reset checklist à¹à¸¥à¹‰à¸§à¹‚à¸«à¸¥à¸”à¹ƒà¸«à¸¡à¹ˆà¸•à¸²à¸¡à¸à¸±à¸ªà¸”à¸¸à¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚
Â  Â  expectedItemsArray = []; scannedItemsMap = {}; isStrictValidationMode = false;
Â  Â  resetRemark();
Â  Â  document.getElementById("orderChecklistPanel").style.display = "none";
Â  Â  checkExpectedItems(text); // à¹‚à¸«à¸¥à¸” checklist à¹ƒà¸«à¸¡à¹ˆ
Â  } else {
Â  Â  speak(`à¸à¸±à¸ªà¸”à¸¸ ${carrier} à¹ƒà¸«à¸¡à¹ˆ à¸¥à¸‡à¸—à¹‰à¸²à¸¢à¸”à¹‰à¸§à¸¢ ${lastFour.split('').join(' ')}`);
Â  Â  startCameraRecording();
Â  Â  checkExpectedItems(text);
Â  }
}

async function cancelWork() {
Â  if (!currentP && items.length === 0) { await closeAppCompletely(); return; }
Â  const result = await Swal.fire({
Â  Â  title: 'ğŸ± à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¢à¸à¹€à¸¥à¸´à¸?',
Â  Â  html: '<div style="font-size:0.92rem; color:#444;">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸§à¸´à¸”à¸µà¹‚à¸­à¸ˆà¸°<strong>à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸</strong>à¸™à¸°à¸„à¸°</div>',
Â  Â  icon: 'warning',
Â  Â  showCancelButton: true,
Â  Â  confirmButtonText: 'âœ– à¸¢à¸à¹€à¸¥à¸´à¸à¸‡à¸²à¸™',
Â  Â  cancelButtonText: 'â†© à¸à¸¥à¸±à¸šà¹„à¸›à¹à¸à¹‡à¸à¸•à¹ˆà¸­',
Â  Â  confirmButtonColor: '#ff8fab',
Â  Â  cancelButtonColor: '#b2bec3',
Â  Â  background: '#fff0f3',
Â  Â  customClass: {
Â  Â  Â  popup: 'swal-popup',
Â  Â  Â  title: 'swal-ttl',
Â  Â  Â  confirmButton: 'swal-btn',
Â  Â  Â  cancelButton: 'swal-btn',
Â  Â  },
Â  Â  reverseButtons: true,
Â  });
Â  if (result.isConfirmed) {
Â  Â  isFinishing = true;
Â  Â  speak("à¸¢à¸à¹€à¸¥à¸´à¸à¸‡à¸²à¸™à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¹ˆà¸°");
Â  Â  await stopCameraRecording();
Â  Â  recordedChunks = [];
Â  Â  await resetAppForNext();
Â  Â  isFinishing = false;
Â  Â  setStatus("âœ– à¸¢à¸à¹€à¸¥à¸´à¸à¸‡à¸²à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢", "secondary");
Â  }
}

async function finishWork(isManual = false) {
Â  const pId = currentP;
Â  if (!pId) { if (isManual) speak("à¸à¸£à¸¸à¸“à¸²à¸ªà¹à¸à¸™à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸à¸à¹ˆà¸­à¸™à¸™à¸°à¸„à¸°"); return; }
Â  if (isStrictValidationMode && !validateCurrentOrder()) {
Â  Â  // à¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸à¸´à¸™ â€” à¸¢à¸±à¸‡à¸šà¸¥à¹‡à¸­à¸à¸­à¸¢à¸¹à¹ˆ
Â  Â  let hasOver = false;
Â  Â  for (let sSku in scannedItemsMap) {
Â  Â  Â  const req = expectedItemsArray.find(ex => ex.sku === sSku);
Â  Â  Â  if (!req || scannedItemsMap[sSku] > req.qty) { hasOver = true; break; }
Â  Â  }
Â  Â  if (hasOver) {
Â  Â  Â  Swal.fire('à¸¢à¸±à¸‡à¸›à¸´à¸”à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰!', 'à¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¸œà¸´à¸”à¸£à¸²à¸¢à¸à¸²à¸£ à¸«à¸£à¸·à¸­ à¹€à¸à¸´à¸™à¸ˆà¸³à¸™à¸§à¸™ à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¹ˆà¸­à¸™', 'error');
Â  Â  Â  speak("à¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸à¸´à¸™à¸ˆà¸³à¸™à¸§à¸™à¸„à¹ˆà¸° à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š"); return;
Â  Â  }
Â  Â  // à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š â€” à¹à¸ªà¸”à¸‡ remark panel à¹à¸—à¸™
Â  Â  if (!currentRemark) {
Â  Â  Â  document.getElementById('remarkPanel').style.display = 'block';
Â  Â  Â  document.getElementById('orderChecklistPanel').scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  speak("à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸šà¸„à¹ˆà¸° à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹€à¸«à¸•à¸¸à¸œà¸¥à¸à¹ˆà¸­à¸™à¸ˆà¸šà¸‡à¸²à¸™", false);
Â  Â  Â  return;
Â  Â  }
Â  }
Â  isFinishing = true;
Â  const snapshotItems = [...items];
Â  const snapshotParcelId = pId;
Â  const videoChunks = await stopCameraRecording();
Â  const count = snapshotItems.length;
Â  const summaryMsg = count > 0 ? `à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸´à¸™à¸„à¹‰à¸² ${count} à¸Šà¸´à¹‰à¸™ à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸„à¹ˆà¸°` : `à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸±à¸ªà¸”à¸¸à¹€à¸šà¸·à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸„à¹ˆà¸°`;

Â  if (isManual) {
Â  Â  await closeAppCompletely();
Â  Â  speak(summaryMsg, false);
Â  Â  setTimeout(() => { isFinishing = false; }, 1500);
Â  } else {
Â  Â  await resetAppForNext();
Â  Â  speak(summaryMsg + " à¸ªà¹à¸à¸™à¸à¸±à¸ªà¸”à¸¸à¹ƒà¸šà¸–à¸±à¸”à¹„à¸›à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¹ˆà¸°", false);
Â  Â  setStatus("â³ à¸à¸³à¸¥à¸±à¸‡à¹€à¸•à¸£à¸µà¸¢à¸¡à¸£à¸±à¸šà¹ƒà¸šà¸–à¸±à¸”à¹„à¸›...", "light");
Â  Â  setTimeout(() => {
Â  Â  Â  isFinishing = false;
Â  Â  Â  lastScanTime = Date.now();
Â  Â  Â  setStatus("âœ” à¸à¸£à¹‰à¸­à¸¡à¸£à¸±à¸šà¸à¸±à¸ªà¸”à¸¸à¹ƒà¸šà¸–à¸±à¸”à¹„à¸›", "success");
Â  Â  }, 1500);
Â  }

Â  sessionParcels[snapshotParcelId] = count;
Â  const snapshotRemark = currentRemark;
Â  processBackgroundUpload(snapshotParcelId, snapshotItems, videoChunks, snapshotRemark);
}

async function processBackgroundUpload(pId, itemsArr, chunks, remarkNote = '') {
Â  try {
Â  Â  const videoData = await convertChunksToBase64(chunks);
Â  Â  await callGAS("saveData", { parcelId: pId, items: itemsArr, videoEvidence: videoData || "no_video", remark: remarkNote || "" });
Â  Â  console.log(`[Background] à¸šà¸±à¸™à¸—à¸¶à¸ ${pId} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
Â  } catch (err) {
Â  Â  console.error(`[Background Error] ${pId}:`, err);
Â  }
}

async function resetAppForNext() {
Â  currentP = ""; items = []; isEditingId = false;
Â  expectedItemsArray = []; scannedItemsMap = {}; isStrictValidationMode = false;
Â  resetRemark();
Â  document.getElementById("orderChecklistPanel").style.display = "none";
Â  document.getElementById("parcelId").innerText = "-";
Â  document.getElementById("count").innerText = "0";
Â  document.getElementById("itemList").innerHTML = "";
Â  document.getElementById("editParcelBtn").style.display = "none";
Â  setStatus("à¸£à¸­à¸à¸±à¸ªà¸”à¸¸à¹ƒà¸šà¹ƒà¸«à¸¡à¹ˆ...", "light");
Â  document.getElementById("rec-label").innerText = "ğŸ”´ à¸£à¸°à¸šà¸šà¸à¸£à¹‰à¸­à¸¡à¸—à¸³à¸‡à¸²à¸™ (à¸ªà¹à¸à¸™à¸à¸±à¸ªà¸”à¸¸à¹ƒà¸šà¸–à¸±à¸”à¹„à¸›à¹„à¸”à¹‰à¹€à¸¥à¸¢)";
}

async function closeAppCompletely() {
Â  if (scanner) { await scanner.clear(); scanner = null; }
Â  document.getElementById("app-header").style.display = "block";
Â  document.getElementById("app-tabs").style.display = "flex";
Â  currentP = ""; items = []; isEditingId = false;
Â  expectedItemsArray = []; scannedItemsMap = {}; isStrictValidationMode = false;
Â  resetRemark();
Â  document.getElementById("orderChecklistPanel").style.display = "none";
Â  document.getElementById("reader").style.display = "none";
Â  document.getElementById("parcelId").innerText = "-";
Â  document.getElementById("count").innerText = "0";
Â  document.getElementById("itemList").innerHTML = "";
Â  document.getElementById("editParcelBtn").style.display = "none";
Â  setStatus("à¸ˆà¸šà¸‡à¸²à¸™à¹à¸¥à¹‰à¸§ à¸£à¸­à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ...", "light");
Â  const startBtn = document.getElementById("startBtn");
Â  startBtn.style.display = "block"; startBtn.disabled = false;
Â  startBtn.innerText = "ğŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸š / à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²";
Â  document.getElementById("action-buttons").style.display = "none";
}

function renderList() {
Â  let ul = document.getElementById("itemList");
Â  ul.innerHTML = "";
Â  [...items].reverse().forEach((c, i) => {
Â  Â  let li = document.createElement("li");
Â  Â  li.className = "list-group-item d-flex justify-content-between align-items-center animate__animated animate__slideInLeft";
Â  Â  li.innerHTML = `<span>${productMap[c] || c}</span> <button class="btn btn-sm text-danger" onclick="removeItem(${items.length - 1 - i})">âœ•</button>`;
Â  Â  ul.appendChild(li);
Â  });
}

function removeItem(idx) {
Â  if (isStrictValidationMode) {
Â  Â  let sku = items[idx];
Â  Â  if (scannedItemsMap[sku] > 0) {
Â  Â  Â  scannedItemsMap[sku]--;
Â  Â  Â  // à¸¥à¸šà¸­à¸­à¸à¸ˆà¸²à¸ map à¹€à¸¥à¸¢à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ 0 à¹€à¸à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰ validate à¸•à¸£à¸§à¸ˆà¹€à¸ˆà¸­
Â  Â  Â  if (scannedItemsMap[sku] === 0) delete scannedItemsMap[sku];
Â  Â  }
Â  }
Â  items.splice(idx, 1);
Â  document.getElementById("count").innerText = items.length;
Â  renderList();
Â  if (isStrictValidationMode) updateChecklistUI();
Â  speak("à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°");
}

// --- Checklist ---
async function checkExpectedItems(tracking) {
Â  document.getElementById("orderChecklistPanel").style.display = "none";
Â  try {
Â  Â  const expectedData = await callGAS("getExpectedOrderDetails", { trackingNo: tracking });
Â  Â  if (expectedData && expectedData.length > 0) {
Â  Â  Â  isStrictValidationMode = true;
Â  Â  Â  expectedItemsArray = expectedData;
Â  Â  Â  scannedItemsMap = {};
Â  Â  Â  items.forEach(sku => { scannedItemsMap[sku] = (scannedItemsMap[sku] || 0) + 1; });
Â  Â  Â  document.getElementById("orderChecklistPanel").style.display = "block";
Â  Â  Â  updateChecklistUI();
Â  Â  Â  speak("à¸à¸£à¸¸à¸“à¸²à¸ªà¹à¸à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸«à¹‰à¸„à¸£à¸šà¸•à¸²à¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¹ƒà¸™à¸£à¸°à¸šà¸šà¸„à¹ˆà¸°", false);
Â  Â  } else {
Â  Â  Â  isStrictValidationMode = false; expectedItemsArray = []; scannedItemsMap = {};
Â  Â  }
Â  } catch (e) {
Â  Â  isStrictValidationMode = false;
Â  }
}

// --- Remark Functions ---
function selectRemark(btn, value) {
Â  document.querySelectorAll('.remark-btn').forEach(b => b.classList.remove('selected'));
Â  btn.classList.add('selected');
Â  currentRemark = value;
Â  const otherBox = document.getElementById('remarkOtherBox');
Â  if (value === 'à¸­à¸·à¹ˆà¸™à¹†') {
Â  Â  otherBox.style.display = 'block';
Â  Â  document.getElementById('remarkOtherInput').focus();
Â  } else {
Â  Â  otherBox.style.display = 'none';
Â  }
}

async function confirmRemarkAndFinish() {
Â  if (!currentRemark) { speak("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹€à¸«à¸•à¸¸à¸œà¸¥à¸à¹ˆà¸­à¸™à¸„à¹ˆà¸°", false); return; }
Â  if (currentRemark === 'à¸­à¸·à¹ˆà¸™à¹†') {
Â  Â  const other = document.getElementById('remarkOtherInput').value.trim();
Â  Â  if (!other) { speak("à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¹€à¸«à¸•à¸¸à¸œà¸¥à¸”à¹‰à¸§à¸¢à¸„à¹ˆà¸°", false); return; }
Â  Â  currentRemark = other;
Â  }
Â  document.getElementById('remarkPanel').style.display = 'none';
Â  speak(`à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸£à¹‰à¸­à¸¡à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸ ${currentRemark} à¸„à¹ˆà¸°`, false);
Â  await finishWork(false); // à¹€à¸£à¸µà¸¢à¸ finishWork à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ à¸•à¸­à¸™à¸™à¸µà¹‰à¸¡à¸µ currentRemark à¹à¸¥à¹‰à¸§
}

function resetRemark() {
Â  currentRemark = '';
Â  document.querySelectorAll('.remark-btn').forEach(b => b.classList.remove('selected'));
Â  document.getElementById('remarkPanel').style.display = 'none';
Â  document.getElementById('remarkOtherBox').style.display = 'none';
Â  document.getElementById('remarkOtherInput').value = '';
}

function updateChecklistUI() {
Â  let html = ""; let isAllMatched = true; let hasOverScan = false;
Â  expectedItemsArray.forEach(item => {
Â  Â  let scanQty = scannedItemsMap[item.sku] || 0;
Â  Â  let statusClass = "", icon = "â³";
Â  Â  if (scanQty === item.qty) { statusClass = "matched"; icon = "âœ…"; }
Â  Â  else if (scanQty > item.qty) { statusClass = "over"; icon = "âŒ"; isAllMatched = false; hasOverScan = true; }
Â  Â  else { isAllMatched = false; }
Â  Â  html += `<div class="checklist-item ${statusClass}"><span>${icon} ${productMap[item.sku] || item.sku}</span><span class="badge bg-${scanQty === item.qty ? 'success' : (scanQty > item.qty ? 'danger' : 'secondary')} rounded-pill">${scanQty} / ${item.qty}</span></div>`;
Â  });
Â  for (let sSku in scannedItemsMap) {
Â  Â  if (!expectedItemsArray.find(ex => ex.sku === sSku) && scannedItemsMap[sSku] > 0) {
Â  Â  Â  html += `<div class="checklist-item over"><span>âŒ ${productMap[sSku] || sSku} (à¸ªà¹ˆà¸§à¸™à¹€à¸à¸´à¸™!)</span><span class="badge bg-danger rounded-pill">${scannedItemsMap[sSku]}</span></div>`;
Â  Â  Â  isAllMatched = false; hasOverScan = true;
Â  Â  }
Â  }
Â  document.getElementById('checklistContent').innerHTML = html;
Â  const alertBox = document.getElementById('orderStatusAlert');
Â  alertBox.style.display = 'block';
Â  if (isAllMatched && !hasOverScan) {
Â  Â  alertBox.className = "alert alert-success mt-2 mb-0 py-2";
Â  Â  alertBox.innerHTML = "<strong>à¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ!</strong> à¸ªà¸´à¸™à¸„à¹‰à¸²à¸„à¸£à¸šà¸–à¹‰à¸§à¸™";
Â  Â  speak("à¸ªà¸´à¸™à¸„à¹‰à¸²à¸„à¸£à¸šà¸–à¹‰à¸§à¸™à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°", false);
Â  } else if (hasOverScan) {
Â  Â  alertBox.className = "alert alert-danger mt-2 mb-0 py-2";
Â  Â  alertBox.innerHTML = "<strong>à¸£à¸°à¸§à¸±à¸‡!</strong> à¸ªà¸´à¸™à¸„à¹‰à¸²à¸œà¸´à¸”à¸£à¸²à¸¢à¸à¸²à¸£ à¸«à¸£à¸·à¸­ à¹€à¸à¸´à¸™à¸ˆà¸³à¸™à¸§à¸™";
Â  } else {
Â  Â  alertBox.className = "alert alert-warning mt-2 mb-0 py-2";
Â  Â  const missing = expectedItemsArray.filter(item => (scannedItemsMap[item.sku] || 0) < item.qty);
Â  Â  if (missing.length === 1) {
Â  Â  Â  const m = missing[0];
Â  Â  Â  const need = m.qty - (scannedItemsMap[m.sku] || 0);
Â  Â  Â  alertBox.innerHTML = `<strong>à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‡à¸...</strong> à¸¢à¸±à¸‡à¸‚à¸²à¸” ${productMap[m.sku] || m.sku} à¸­à¸µà¸ ${need} à¸Šà¸´à¹‰à¸™`;
Â  Â  } else {
Â  Â  Â  alertBox.innerHTML = `<strong>à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‡à¸...</strong> à¸¢à¸±à¸‡à¸‚à¸²à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²à¸­à¸µà¸ ${missing.length} à¸£à¸²à¸¢à¸à¸²à¸£`;
Â  Â  }
Â  }
}

function validateCurrentOrder() {
Â  if (!isStrictValidationMode) return true;
Â  for (let item of expectedItemsArray) { if ((scannedItemsMap[item.sku] || 0) !== item.qty) return false; }
Â  for (let sSku in scannedItemsMap) {
Â  Â  let reqItem = expectedItemsArray.find(ex => ex.sku === sSku);
Â  Â  if (!reqItem || scannedItemsMap[sSku] > reqItem.qty) return false;
Â  }
Â  return true;
}

// --- Upload Marketplace ---
async function processFileUpload() {
Â  const fileInput = document.getElementById('fileInput');
Â  const marketplace = document.getElementById('marketplaceSelect').value;
Â  if (!fileInput.files.length) { Swal.fire('à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”', 'à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¸à¹ˆà¸­à¸™', 'warning'); return; }

Â  Swal.fire({ title: 'à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

Â  const file = fileInput.files[0];
Â  const map = colMappings[marketplace];

Â  try {
Â  Â  let rows = [];

Â  Â  // Page365 à¹€à¸›à¹‡à¸™ CSV (Tab-separated, UTF-16)
Â  Â  if (map.isCsv) {
Â  Â  Â  const text = await file.text();
Â  Â  Â  // à¹ƒà¸Šà¹‰ PapaParse à¹€à¸à¸·à¹ˆà¸­ parse CSV à¸­à¸¢à¹ˆà¸²à¸‡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸£à¸­à¸‡à¸£à¸±à¸š field à¸—à¸µà¹ˆà¸¡à¸µ tab/newline à¸‚à¹‰à¸²à¸‡à¹ƒà¸™)
Â  Â  Â  const parsed = Papa.parse(text, { delimiter: '\t', skipEmptyLines: true });
Â  Â  Â  rows = parsed.data;
Â  Â  } else {
Â  Â  Â  const buffer = await file.arrayBuffer();
Â  Â  Â  const workbook = XLSX.read(new Uint8Array(buffer), { type: 'array' });
Â  Â  Â  rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, raw: false });
Â  Â  }

Â  Â  let extractData = [];
Â  Â  const startRow = map.headerRows || 1;

Â  Â  if (marketplace === 'lazada') {
Â  Â  Â  // Lazada: 1 row = 1 à¸Šà¸´à¹‰à¸™ à¹„à¸¡à¹ˆà¸¡à¸µ qty column â€” group by tracking
Â  Â  Â  const trackingMap = {};
Â  Â  Â  for (let i = startRow; i < rows.length; i++) {
Â  Â  Â  Â  const row = rows[i];
Â  Â  Â  Â  if (!row) continue;
Â  Â  Â  Â  const tracking = String(row[map.tracking] || '').trim().toUpperCase();
Â  Â  Â  Â  const skuÂ  Â  Â  = String(row[map.sku]Â  Â  Â  || '').trim().toUpperCase();
Â  Â  Â  Â  if (!tracking || !sku || tracking === 'UNDEFINED' || sku === 'UNDEFINED') continue;
Â  Â  Â  Â  const key = tracking + '|' + sku;
Â  Â  Â  Â  trackingMap[key] = (trackingMap[key] || 0) + 1;
Â  Â  Â  }
Â  Â  Â  for (const key in trackingMap) {
Â  Â  Â  Â  const [tracking, sku] = key.split('|');
Â  Â  Â  Â  extractData.push({ marketplace, tracking, sku, qty: trackingMap[key] });
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  for (let i = startRow; i < rows.length; i++) {
Â  Â  Â  Â  const row = rows[i];
Â  Â  Â  Â  if (!row) continue;
Â  Â  Â  Â  const tracking = String(row[map.tracking] || '').trim().toUpperCase();
Â  Â  Â  Â  const skuÂ  Â  Â  = String(row[map.sku]Â  Â  Â  || '').trim().toUpperCase();
Â  Â  Â  Â  const qtyÂ  Â  Â  = parseInt(row[map.qty]) || 1;
Â  Â  Â  Â  if (!tracking || !sku || tracking === 'UNDEFINED' || sku === 'UNDEFINED') continue;
Â  Â  Â  Â  // à¸à¸£à¸­à¸‡à¹à¸–à¸§à¸—à¸µà¹ˆ tracking à¸ªà¸±à¹‰à¸™à¹€à¸à¸´à¸™à¸«à¸£à¸·à¸­à¸¡à¸µà¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡ (header row)
Â  Â  Â  Â  if (tracking.length < 5 || tracking.includes(' ')) continue;
Â  Â  Â  Â  extractData.push({ marketplace, tracking, sku, qty });
Â  Â  Â  }
Â  Â  }

Â  Â  if (extractData.length === 0) {
Â  Â  Â  Swal.fire('à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™', 'à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥\nà¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸¥à¸·à¸­à¸ Marketplace à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ', 'warning');
Â  Â  Â  return;
Â  Â  }

Â  Â  // à¸ªà¹ˆà¸‡à¹„à¸› GAS à¸à¸£à¹‰à¸­à¸¡à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¹€à¸à¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ duplicate
Â  Â  const response = await callGAS("saveMarketplaceData", {
Â  Â  Â  data: extractData,
Â  Â  Â  fileName: file.name,Â  // à¸ªà¹ˆà¸‡à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¹„à¸›à¸•à¸£à¸§à¸ˆ duplicate
Â  Â  Â  marketplace
Â  Â  });

Â  Â  if (response && response.success) {
Â  Â  Â  const dupMsg = response.duplicateSkipped > 0 ? `\n(à¸‚à¹‰à¸²à¸¡à¸‹à¹‰à¸³ ${response.duplicateSkipped} à¸£à¸²à¸¢à¸à¸²à¸£)` : '';
Â  Â  Â  Swal.fire('à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', `à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${response.count} à¸£à¸²à¸¢à¸à¸²à¸£${dupMsg}`, 'success');
Â  Â  Â  bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
Â  Â  Â  document.getElementById('fileInput').value = "";
Â  Â  } else {
Â  Â  Â  Swal.fire('à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”', 'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + (response?.error || ''), 'error');
Â  Â  }
Â  } catch (err) {
Â  Â  Swal.fire('à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”', 'à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¹„à¸”à¹‰: ' + err.message, 'error');
Â  }
}

// --- Search ---
function openTab(tab, btn) {
Â  document.querySelectorAll('#scan, #search, #dash').forEach(el => el.style.display = 'none');
Â  document.getElementById(tab).style.display = 'block';
Â  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
Â  btn.classList.add('active');
Â  if (tab === 'dash') {
Â  Â  refreshDash();
Â  Â  // auto load à¸§à¸±à¸™à¸™à¸µà¹‰à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸
Â  Â  if (!document.getElementById('dashStart').value) {
Â  Â  Â  setPreset('today', document.querySelector('.preset-btn'));
Â  Â  }
Â  }
Â  if (tab !== 'search' && searchScanner) { searchScanner.clear(); document.getElementById("search-reader").style.display = "none"; }
}

function refreshDash() {
Â  // à¸­à¸±à¸›à¹€à¸”à¸• summary cards à¸ˆà¸²à¸ session
Â  const orders = Object.keys(sessionParcels).length;
Â  const itemsÂ  = Object.values(sessionParcels).reduce((a, b) => a + b, 0);
Â  document.getElementById("d-box").innerTextÂ  = orders;
Â  document.getElementById("d-item").innerText = items;
}

function localDateStr(d) {
Â  // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ YYYY-MM-DD à¸•à¸²à¸¡à¹€à¸§à¸¥à¸²à¸—à¹‰à¸­à¸‡à¸–à¸´à¹ˆà¸™ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ UTC
Â  const y = d.getFullYear();
Â  const m = String(d.getMonth() + 1).padStart(2, '0');
Â  const day = String(d.getDate()).padStart(2, '0');
Â  return `${y}-${m}-${day}`;
}

function setPreset(type, btnEl) {
Â  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
Â  if (btnEl) btnEl.classList.add('active');
Â  const today = new Date();
Â  let start = new Date(today), end = new Date(today);

Â  if (type === 'yesterday') {
Â  Â  start = new Date(today); start.setDate(today.getDate() - 1);
Â  Â  endÂ  Â = new Date(start);
Â  } else if (type === 'last7') {
Â  Â  start = new Date(today); start.setDate(today.getDate() - 6);
Â  } else if (type === 'thisMonth') {
Â  Â  start = new Date(today.getFullYear(), today.getMonth(), 1);
Â  } else if (type === 'lastMonth') {
Â  Â  start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
Â  Â  endÂ  Â = new Date(today.getFullYear(), today.getMonth(), 0);
Â  }

Â  // à¹ƒà¸Šà¹‰ localDateStr à¹à¸—à¸™ valueAsDate à¹€à¸à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¹€à¸à¸µà¹‰à¸¢à¸™ UTC
Â  document.getElementById('dashStart').value = localDateStr(start);
Â  document.getElementById('dashEnd').valueÂ  Â = localDateStr(end);
Â  fetchReport();
}

async function fetchReport() {
Â  const start = document.getElementById('dashStart').value;
Â  const endÂ  Â = document.getElementById('dashEnd').value;
Â  if (!start || !end) return;

Â  document.getElementById('dashLoading').style.display = 'block';
Â  document.getElementById('dashContent').style.display = 'none';

Â  try {
Â  Â  const data = await callGAS("getReportData", { start, end });
Â  Â  renderReport(data, start, end);
Â  } catch(e) {
Â  Â  document.getElementById('dashLoading').style.display = 'none';
Â  Â  Swal.fire('à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', e.message, 'error');
Â  }
}

function renderReport(data, start, end) {
Â  document.getElementById('dashLoading').style.display = 'none';
Â  document.getElementById('dashContent').style.display = 'block';

Â  // period label
Â  const fmt = d => new Date(d).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'});
Â  document.getElementById('dashPeriod').innerText = start === end ? fmt(start) : `${fmt(start)} â€“ ${fmt(end)}`;

Â  // stats
Â  document.getElementById('d-box').innerTextÂ  = data.totalOrdersÂ  ?? Object.keys(sessionParcels).length;
Â  document.getElementById('d-item').innerText = data.totalItemsÂ  Â ?? Object.values(sessionParcels).reduce((a,b)=>a+b,0);

Â  // product table
Â  const container = document.getElementById('dashProductTable');
Â  const productsÂ  = data.allProducts || [];
Â  if (products.length === 0) {
Â  Â  container.innerHTML = '<div class="text-center small py-4" style="color:#c49aaa;">ğŸ˜¿ à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</div>';
Â  Â  return;
Â  }
Â  container.innerHTML = products.map((item, i) => `
Â  Â  <div class="dash-row">
Â  Â  Â  <div style="display:flex; align-items:center; gap:10px; overflow:hidden;">
Â  Â  Â  Â  <div class="dash-rank">${i+1}</div>
Â  Â  Â  Â  <div style="overflow:hidden;">
Â  Â  Â  Â  Â  <div style="font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.name}</div>
Â  Â  Â  Â  Â  <div style="font-size:0.72rem; color:#b0889a;">${item.sku || ''}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="dash-count">${item.count}<span style="font-size:0.7rem; font-weight:400; color:#c49aaa;"> à¸Šà¸´à¹‰à¸™</span></div>
Â  Â  </div>
Â  `).join('');
}

async function resetSession() {
Â  const r = await Swal.fire({
Â  Â  title: 'ğŸ€ à¸¥à¹‰à¸²à¸‡à¸ªà¸–à¸´à¸•à¸´?',
Â  Â  html: '<div style="font-size:0.88rem; color:#444;">à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¥à¹‰à¸²à¸‡à¸ªà¸–à¸´à¸•à¸´à¸£à¸­à¸šà¸™à¸µà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸™à¸°à¸„à¸°</div>',
Â  Â  icon: 'question',
Â  Â  showCancelButton: true,
Â  Â  confirmButtonText: 'ğŸ—‘ï¸ à¸¥à¹‰à¸²à¸‡à¹€à¸¥à¸¢',
Â  Â  cancelButtonText: 'à¸¢à¸à¹€à¸¥à¸´à¸',
Â  Â  confirmButtonColor: '#ff8fab',
Â  Â  cancelButtonColor: '#b2bec3',
Â  Â  background: '#fff0f3',
Â  Â  reverseButtons: true,
Â  });
Â  if (r.isConfirmed) { sessionParcels = {}; refreshDash(); }
}

function startSearchScan() {
Â  const readerDiv = document.getElementById("search-reader");
Â  readerDiv.style.display = "block";
Â  if (searchScanner) searchScanner.clear();
Â  searchScanner = new Html5QrcodeScanner("search-reader", { fps: 15, qrbox: { width: 250, height: 250 } });
Â  searchScanner.render((text) => {
Â  Â  document.getElementById("searchInput").value = text;
Â  Â  speak("à¸ªà¹à¸à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸„à¹ˆà¸°");
Â  Â  searchScanner.clear().then(() => { readerDiv.style.display = "none"; runSearch(); });
Â  });
}

function handleEnter(e) { if (e.key === "Enter") runSearch(); }

async function runSearch() {
Â  const q = document.getElementById("searchInput").value.trim();
Â  if (!q) return;
Â  document.getElementById("loadingSearch").style.display = "block";
Â  document.getElementById("resultBody").innerHTML = "";
Â  try {
Â  Â  const res = await callGAS("searchData", { query: q });
Â  Â  document.getElementById("loadingSearch").style.display = "none";
Â  Â  const tb = document.getElementById("resultBody"), th = document.getElementById("tableHead");
Â  Â  tb.innerHTML = ""; th.innerHTML = "";
Â  Â  if (!res || res.length === 0) {
Â  Â  Â  tb.innerHTML = "<tr><td colspan='5' class='text-center py-4 text-muted'>âŒ à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</td></tr>";
Â  Â  Â  speak("à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¹ˆà¸°"); return;
Â  Â  }
Â  Â  const max = Math.max(...res.map(r => r.length));
Â  Â  let head = "<tr><th>à¸§à¸±à¸™à¸—à¸µà¹ˆ</th><th>à¸£à¸«à¸±à¸ªà¸à¸±à¸ªà¸”à¸¸</th><th>à¸§à¸´à¸”à¸µà¹‚à¸­</th>";
Â  Â  for (let i = 3; i < max; i++) head += `<th>à¸ªà¸´à¸™à¸„à¹‰à¸² ${i - 2}</th>`;
Â  Â  th.innerHTML = head + "</tr>";
Â  Â  res.forEach(row => {
Â  Â  Â  let tr = "<tr>";
Â  Â  Â  row.forEach(cell => { tr += `<td>${String(cell).includes("http") ? `<a href="${cell}" target="_blank" class="btn btn-sm btn-outline-primary">à¸”à¸¹à¸„à¸¥à¸´à¸›</a>` : cell}</td>`; });
Â  Â  Â  tb.innerHTML += tr + "</tr>";
Â  Â  });
Â  Â  const rawItems = res[0].slice(3).filter(i => i && !String(i).includes("http"));
Â  Â  if (rawItems.length > 0) speak(`à¸ˆà¸³à¸™à¸§à¸™à¸ªà¸´à¸™à¸„à¹‰à¸² ${rawItems.length} à¸£à¸²à¸¢à¸à¸²à¸£à¸„à¹ˆà¸°`);
Â  Â  else speak("à¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²à¸„à¹ˆà¸°");
Â  } catch (err) {
Â  Â  document.getElementById("loadingSearch").style.display = "none";
Â  Â  Swal.fire('à¸„à¹‰à¸™à¸«à¸²à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', err.message, 'error');
Â  }
}
</script>

<script>
// === CAT & PAWS ANIMATIONS ===
(function() {
Â  // à¸ªà¸£à¹‰à¸²à¸‡ floating paws
Â  const pawBg = document.getElementById('pawBg');
Â  if (!pawBg) return;
Â  const pawEmojis = ['ğŸ¾','ğŸŒ¸','âœ¦','ğŸ’•','ğŸ€','â­'];
Â  for (let i = 0; i < 18; i++) {
Â  Â  const el = document.createElement('div');
Â  Â  el.className = 'paw';
Â  Â  el.textContent = pawEmojis[i % pawEmojis.length];
Â  Â  el.style.left = Math.random() * 100 + 'vw';
Â  Â  el.style.animationDuration = (12 + Math.random() * 16) + 's';
Â  Â  el.style.animationDelay = (Math.random() * 14) + 's';
Â  Â  el.style.fontSize = (0.9 + Math.random() * 1.4) + 'rem';
Â  Â  pawBg.appendChild(el);
Â  }
})();

// Cat tap animation

// spawn sparkle

// spawn sparkle on scan success
const origProcessFinal = processFinalScan;
window.processFinalScanWrapped = async function(text) {
Â  await origProcessFinal(text);
Â  // sparkle at center screen on product scan
Â  if (text.trim().toUpperCase().startsWith('B')) {
Â  Â  setTimeout(() => spawnSparkle(window.innerWidth/2 - 30, window.innerHeight/2 - 20), 150);
Â  }
};
</script>
</body>
</html>
