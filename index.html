<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner PRO 2.5 (Background Upload Edition)</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/SN96rHc6/icons8-barcode-scanner-100.png">
  
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    :root {
      --primary-pink: #ff69b4;
      --soft-pink: #ffd6e8;
      --bg-color: #fdf6ff;
      --accent-blue: #74b9ff;
      --recording-red: #ff4757;
    }

    body {
      background: var(--bg-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #2d3436;
    }

    .tab-bar {
      display: flex;
      justify-content: space-around;
      background: white;
      padding: 8px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      margin-bottom: 25px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 12px 20px;
      border-radius: 15px;
      font-weight: 600;
      color: #b2bec3;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: var(--primary-pink);
      color: white;
      box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
    }

    .card {
      border-radius: 30px;
      border: none;
      background: white;
      box-shadow: 0 15px 35px rgba(0,0,0,0.05);
    }

    #reader, #search-reader {
      width: 100%;
      max-width: 450px;
      margin: auto;
      border-radius: 25px;
      overflow: hidden;
      border: 8px solid white;
      box-shadow: 0 0 0 4px var(--soft-pink);
    }

    .btn-custom {
      border-radius: 20px;
      padding: 15px;
      font-weight: 700;
      border: none;
      transition: all 0.2s;
    }

    .btn-main { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
    .btn-save { background: linear-gradient(135deg, #ff7675, #d63031); color: white; }
    .btn-cancel { background: #636e72; color: white; }

    .status-badge {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: bold;
      margin-top: 10px;
    }

    #rec-ui {
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #video-preview {
      display: none;
    }

    .rec-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    .rec-dot {
      width: 12px;
      height: 12px;
      background: red;
      border-radius: 50%;
      margin-right: 10px;
      animation: blink 1s infinite;
    }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

    .list-group-item {
      border: none;
      background: #f8f9fa;
      margin-bottom: 10px;
      border-radius: 18px !important;
      padding: 15px;
    }

    .btn-edit-inline {
      padding: 2px 8px;
      font-size: 0.75rem;
      border-radius: 10px;
      margin-left: 8px;
      vertical-align: middle;
      border: 1px solid #ddd;
      background: #fdfdfd;
      color: #666;
    }
    .btn-edit-inline:hover {
      background: #eee;
    }
  </style>
</head>

<body>
<canvas id="overlayCanvas" style="display:none;"></canvas>

<div class="container mt-4 pb-5">
  <div id="app-header" class="text-center mb-4 animate__animated animate__fadeIn">
    <h2 class="fw-bold" style="color: var(--primary-pink)">üå∏ Scanner PRO 2.5</h2>
    <p class="text-muted small">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏û‡πá‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (Background Upload)</p>
  </div>

  <div id="app-tabs" class="tab-bar animate__animated animate__fadeInDown">
    <button class="tab-btn active" onclick="openTab('scan', this)">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button>
    <button class="tab-btn" onclick="openTab('search', this)">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    <button class="tab-btn" onclick="openTab('dash', this)">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <!-- TAB: SCAN -->
  <div id="scan" class="animate__animated animate__fadeIn">
    <div class="card p-4 text-center">
      
      <div id="rec-ui" class="mb-3 p-2 border rounded-4 bg-light shadow-sm">
        <div id="rec-status">
           <span id="rec-label" class="text-muted small fw-bold">üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô)</span>
        </div>
        <video id="video-preview" autoplay playsinline muted></video>
      </div>

      <button id="startBtn" onclick="initScanner()" class="btn-custom btn-main mb-3 w-100 shadow">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö / ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      
      <div id="reader" style="display:none"></div>

      <div class="mt-4 p-3 bg-light rounded-4 border">
        <div class="row align-items-center">
          <div class="col-7 text-start border-end">
            <h6 class="text-muted mb-1 small fw-bold">üì¶ ‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h6>
            <div class="d-flex align-items-center">
              <h5 id="parcelId" class="text-primary mb-0 fw-bold">-</h5>
              <button id="editParcelBtn" onclick="editParcelId()" class="btn btn-edit-inline" style="display:none">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
          </div>
          <div class="col-5">
            <h6 class="text-muted mb-1 small fw-bold">üßæ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h6>
            <h4 id="count" class="mb-0 fw-bold">0</h4>
          </div>
        </div>
      </div>

      <div id="statusLabel" class="status-badge bg-light text-muted">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</div>

      <div class="mt-3 text-start">
        <h6 class="fw-bold ms-2 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ:</h6>
        <ul id="itemList" class="list-group"></ul>
      </div>

      <div id="action-buttons" class="mt-4" style="display:none">
        <div class="row g-2">
          <div class="col-8">
            <button id="saveBtn" onclick="finishWork(true)" class="btn-custom btn-save w-100 shadow">üíæ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
          <div class="col-4">
            <button id="cancelBtn" onclick="cancelWork()" class="btn-custom btn-cancel w-100 shadow">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- TAB: SEARCH -->
  <div id="search" style="display:none" class="animate__animated animate__fadeIn">
    <div class="card p-4">
      <div class="mb-3">
        <div id="search-reader" style="display:none; margin-bottom: 15px;"></div>
        <div class="input-group">
          <input id="searchInput" class="form-control rounded-start-4 p-3" 
                 placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà)..."
                 onkeypress="handleEnter(event)">
          <button class="btn btn-primary px-3" onclick="startSearchScan()" title="‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á">üì∑</button>
          <button class="btn btn-success rounded-end-4 px-4" onclick="runSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
        <div class="form-text text-muted ms-2 small">üí° ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏ä‡πà‡∏ô th22 ‡∏´‡∏£‡∏∑‡∏≠ TH22)</div>
      </div>
      <div id="loadingSearch" class="text-center my-3" style="display:none">
        <div class="spinner-border text-pink"></div>
        <p class="small text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>
      </div>
      <div class="table-responsive">
        <table class="table table-hover small">
          <thead id="tableHead" class="table-light"></thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB: DASHBOARD -->
  <div id="dash" style="display:none" class="animate__animated animate__fadeIn">
     <div class="row g-3 text-center">
        <div class="col-6">
          <div class="card p-4 border-bottom border-primary border-5">
            <h6 class="text-muted">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</h6>
            <h1 id="d-box" class="display-4 fw-bold text-primary">0</h1>
          </div>
        </div>
        <div class="col-6">
          <div class="card p-4 border-bottom border-success border-5">
            <h6 class="text-muted">üßæ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</h6>
            <h1 id="d-item" class="display-4 fw-bold text-success">0</h1>
          </div>
        </div>
     </div>
     <div class="mt-4 text-center">
        <button class="btn btn-outline-secondary btn-sm" onclick="resetSession()">‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</button>
     </div>
  </div>

</div>

<script>
// --- MOCKUP for Preview ---
if (typeof google === 'undefined') {
  window.google = {
    script: {
      run: {
        withSuccessHandler: function(s) { this.successHandler = s; return this; },
        withFailureHandler: function(f) { this.failureHandler = f; return this; },
        getProductData: function() {
          setTimeout(() => { if (this.successHandler) this.successHandler({"B001": "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ A", "B002": "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ B"}); }, 500);
          return this;
        },
        saveData: function(data) { 
          console.log("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á:", data.parcelId); 
          setTimeout(() => { if (this.successHandler) this.successHandler("SUCCESS"); }, 3000);
          return this; 
        },
        searchData: function(query) {
          setTimeout(() => { 
            const mockDB = [
              ["11/01/2026 18:00:00", "TH22035J0DY80F", "https://example.com", "B001", "B002"],
              ["12/01/2026 09:30:00", "TH123456789ABC", "https://example.com", "B003"]
            ];
            const q = query.toLowerCase().trim();
            const results = mockDB.filter(row => row[1].toLowerCase().includes(q));
            if (this.successHandler) this.successHandler(results); 
          }, 800);
          return this;
        }
      }
    }
  };
}

let mediaRecorder;      
let recordedChunks = []; 
let cameraStream = null; 
let isRecording = false; 

function getSupportedMimeType() {
  return 'video/webm;codecs=vp8';
}

async function startCameraRecording() {
  if (isRecording) return;
  const videoEl = document.getElementById('video-preview');
  const canvas = document.getElementById('overlayCanvas');
  const ctx = canvas.getContext('2d');
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    videoEl.srcObject = cameraStream;
    await videoEl.play();
    canvas.width = videoEl.videoWidth;
    canvas.height = videoEl.videoHeight;
    recordedChunks = [];

    function drawOverlay() {
      if (!isRecording && !cameraStream) return;
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
      const overlayHeight = 160 + items.length * 26;
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, overlayHeight);
      ctx.fillStyle = "#ffffff";
      ctx.font = "22px sans-serif";
      const now = new Date().toLocaleString("th-TH");
      let y = canvas.height - overlayHeight + 30;
      ctx.fillText("üìÖ " + now, 20, y);
      y += 30;
      ctx.fillText("üì¶ ‡∏û‡∏±‡∏™‡∏î‡∏∏: " + (currentP || "-"), 20, y);
      y += 30;
      ctx.fillText("üßæ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: " + items.length + " ‡∏ä‡∏¥‡πâ‡∏ô", 20, y);
      ctx.font = "20px sans-serif";
      items.forEach((sku, index) => {
        y += 26;
        const name = productMap[sku] || sku;
        ctx.fillText(`- ${name}`, 40, y);
      });
      requestAnimationFrame(drawOverlay);
    }
    drawOverlay();
    const canvasStream = canvas.captureStream(30);
    mediaRecorder = new MediaRecorder(canvasStream, {
      mimeType: 'video/webm;codecs=vp8',
      videoBitsPerSecond: 2500000
    });
    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) recordedChunks.push(e.data);
    };
    mediaRecorder.start();
    isRecording = true;
    document.getElementById('rec-label').innerHTML =
      '<div class="rec-indicator"><span class="rec-dot"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</div>';
  } catch (err) {
    console.error("Camera/Overlay error:", err);
    document.getElementById('rec-label').innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ";
  }
}

function stopCameraRecording() {
  return new Promise((resolve) => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
      resolve([]); return;
    }
    mediaRecorder.addEventListener('stop', () => {
      isRecording = false;
      const snapshot = [...recordedChunks]; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á
      if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
      document.getElementById('rec-label').innerText = "üî¥ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
      resolve(snapshot);
    }, { once: true });
    mediaRecorder.stop();
  });
}

// ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö chunks ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ global
async function convertChunksToBase64(chunks) {
  if (!chunks || chunks.length === 0) return "";
  const blob = new Blob(chunks, { type: 'video/webm' });
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      if (!reader.result || typeof reader.result !== 'string') { resolve(""); return; }
      const idx = reader.result.indexOf(',');
      resolve(idx > -1 ? reader.result.slice(idx + 1) : "");
    };
    reader.onerror = () => resolve("");
    reader.readAsDataURL(blob);
  });
}

let productMap = {}, currentP = "", items = [], scanner, searchScanner, lastScanTime = 0;
let sessionParcels = {}; 
let scanBuffer = [];
let bufferTimeout = null;
let isFinishing = false; 
let isEditingId = false; 

function speak(t, priority = true) {
  if (!window.speechSynthesis) return;
  if (priority) speechSynthesis.cancel(); 
  const m = new SpeechSynthesisUtterance(t);
  m.lang = "th-TH"; m.rate = 1.3;
  speechSynthesis.speak(m);
}

function initScanner() {
  const btn = document.getElementById("startBtn");
  btn.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
  google.script.run.withSuccessHandler(res => {
    productMap = res; 
    document.getElementById("app-header").style.display = "none";
    document.getElementById("app-tabs").style.display = "none";
    btn.style.display = "none";
    document.getElementById("action-buttons").style.display = "block";
    speak("‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
    startScan(); 
  }).getProductData();
}

function startScan() {
  document.getElementById("reader").style.display = "block";
  if (!scanner) {
    scanner = new Html5QrcodeScanner("reader", { 
      fps: 20, 
      qrbox: { width: 300, height: 350 },
      rememberLastUsedCamera: true
    });
    scanner.render((text, result) => onScanBuffer(text, result));
  }
}

function onScanBuffer(text, result) {
  const now = Date.now();
  if (isFinishing || now - lastScanTime < 2500) return; 

  let yPos = 9999;
  if (result && result.result && result.result.location) {
    yPos = result.result.location.topLeftCorner.y;
  }

  scanBuffer.push({ text: text, y: yPos });

  if (!bufferTimeout) {
    bufferTimeout = setTimeout(() => {
      scanBuffer.sort((a, b) => a.y - b.y);
      const topMost = scanBuffer[0];
      processFinalScan(topMost.text);
      scanBuffer = [];
      bufferTimeout = null;
    }, 300);
  }
}

async function processFinalScan(text) {
  const upperText = text.trim().toUpperCase();
  const isFlash = upperText.startsWith("TH") && (upperText.length === 15 || upperText.length === 14);
  const isJT = /^\d{12}$/.test(upperText) || /^(81|82|83|86|JET)/.test(upperText);
  const isProduct = upperText.startsWith("B");

  if (isProduct) {
    if (!currentP && !isEditingId) { 
      speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞"); 
      return; 
    }
    lastScanTime = Date.now();
    items.push(text); 
    document.getElementById("count").innerText = items.length;
    renderList(); 
    speak(productMap[text] || text);
    document.getElementById("statusLabel").innerText = "‚úî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: " + text;
    document.getElementById("statusLabel").className = "status-badge bg-success text-white";
  } 
  else if (isFlash || isJT) {
    lastScanTime = Date.now();
    const carrier = isFlash ? "‡πÅ‡∏ü‡∏•‡∏ä" : "‡πÄ‡∏à ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡∏ó‡∏µ";
    
    if (sessionParcels[upperText] && !isEditingId) {
      speak("‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ");
      document.getElementById("statusLabel").innerText = "‚ùå ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏£‡∏´‡∏±‡∏™ " + upperText + " ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
      document.getElementById("statusLabel").className = "status-badge bg-danger text-white";
      return;
    }

    if (upperText === currentP && !isEditingId) {
      if (items.length === 0) {
        speak("‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞ ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏∞");
        document.getElementById("statusLabel").innerText = "‚ö†Ô∏è ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏á)";
        document.getElementById("statusLabel").className = "status-badge bg-warning text-dark";
        return;
      }
      speak("‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á");
      finishWork(false); 
      return;
    }

    if (currentP && upperText !== currentP && !isEditingId) {
        speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏≤‡∏Å‡∏¢‡∏¥‡∏á‡∏ú‡∏¥‡∏î‡∏Ñ‡πà‡∏∞");
        document.getElementById("statusLabel").innerText = "‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô";
        document.getElementById("statusLabel").className = "status-badge bg-danger text-white";
        return; 
    }

    processNewParcel(upperText, carrier);
  } 
  else {
    lastScanTime = Date.now();
    speak("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πà‡∏∞");
    document.getElementById("statusLabel").innerText = "‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    document.getElementById("statusLabel").className = "status-badge bg-warning text-dark";
  }
}

function editParcelId() {
  if (!currentP && items.length === 0) return;
  speak("‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞");
  isEditingId = true;
  currentP = ""; 
  document.getElementById("parcelId").innerText = "‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà...";
  document.getElementById("statusLabel").innerText = "‚úèÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏...";
  document.getElementById("statusLabel").className = "status-badge bg-info text-white";
  document.getElementById("editParcelBtn").style.display = "none";
}

function processNewParcel(text, carrier) {
    const wasEditing = isEditingId;
    currentP = text;
    
    if (!wasEditing) {
      items = [];
    }
    isEditingId = false; 
    
    document.getElementById("parcelId").innerText = text;
    document.getElementById("count").innerText = items.length;
    renderList(); 
    document.getElementById("statusLabel").innerText = (wasEditing ? "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏õ‡πá‡∏ô: " : `üì¶ ‡∏û‡∏±‡∏™‡∏î‡∏∏ ${carrier}: `) + text;
    document.getElementById("statusLabel").className = "status-badge bg-primary text-white";
    document.getElementById("editParcelBtn").style.display = "inline-block";
    
    const lastFour = text.length >= 4 ? text.slice(-4) : text;
    const speechOutput = lastFour.split('').join(' ');
    
    if (wasEditing) {
      speak(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™ ${speechOutput} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`, true);
    } else {
      speak(`‡∏û‡∏±‡∏™‡∏î‡∏∏ ${carrier} ‡πÉ‡∏´‡∏°‡πà ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ ${speechOutput}`, true);
      startCameraRecording(); 
    }
}

async function cancelWork() {
  if (!currentP && items.length === 0) {
    await closeAppCompletely();
    return;
  }

  if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)")) {
    isFinishing = true;
    speak("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞");
    await stopCameraRecording();
    recordedChunks = []; 
    await resetAppForNext();
    isFinishing = false;
    document.getElementById("statusLabel").innerText = "‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    document.getElementById("statusLabel").className = "status-badge bg-secondary text-white";
  }
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Background Logic) ---
async function finishWork(isManual = false) {
  const count = items.length;
  const pId = currentP; 
  
  if (!pId) {
      if (isManual) speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞"); 
      return;
  }
  
  isFinishing = true; // ‡∏•‡πá‡∏≠‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå
  
  // 1. Snapshot ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  const snapshotItems = [...items];
  const snapshotParcelId = pId;

  // 2. ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á Chunks ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
  const videoChunks = await stopCameraRecording();
  
  // 3. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Upload)
  const summaryMsg = (count > 0) 
        ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${count} ‡∏ä‡∏¥‡πâ‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`
        : `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`;

  if (isManual) { 
    await closeAppCompletely(); 
    speak(summaryMsg, false);
    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
    setTimeout(() => {
        isFinishing = false;
    }, 1500);
  } else { 
    await resetAppForNext(); 
    speak(summaryMsg + " ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞", false);
    
    document.getElementById("statusLabel").innerText = "‚è≥ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)...";
    document.getElementById("statusLabel").className = "status-badge bg-light text-muted";

    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å (isFinishing = false)
    setTimeout(() => {
        isFinishing = false; 
        lastScanTime = Date.now(); 
        document.getElementById("statusLabel").innerText = "‚úî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
        document.getElementById("statusLabel").className = "status-badge bg-success text-white";
    }, 1500);
  }

  // 4. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Async Process)
  sessionParcels[snapshotParcelId] = count; 
  processBackgroundUpload(snapshotParcelId, snapshotItems, videoChunks);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á UI ‡∏´‡∏•‡∏±‡∏Å
async function processBackgroundUpload(pId, itemsArr, chunks) {
  try {
    const videoData = await convertChunksToBase64(chunks);
    google.script.run
      .withSuccessHandler(() => {
        console.log(`[Background] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${pId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
      })
      .withFailureHandler((err) => {
        console.error(`[Background Error] ${pId}:`, err);
      })
      .saveData({ 
        parcelId: pId, 
        items: itemsArr, 
        videoEvidence: videoData || "no_video" 
      });
  } catch (err) {
    console.error("Background processing failed:", err);
  }
}

async function resetAppForNext() {
  currentP = ""; items = []; isEditingId = false;
  document.getElementById("parcelId").innerText = "-";
  document.getElementById("count").innerText = "0";
  document.getElementById("itemList").innerHTML = "";
  document.getElementById("editParcelBtn").style.display = "none";
  document.getElementById("statusLabel").innerText = "‡∏£‡∏≠‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà...";
  document.getElementById("statusLabel").className = "status-badge bg-light text-muted";
  document.getElementById("rec-label").innerText = "üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)";
}

async function closeAppCompletely() {
  if (scanner) { await scanner.clear(); scanner = null; }
  document.getElementById("app-header").style.display = "block";
  document.getElementById("app-tabs").style.display = "flex";
  currentP = ""; items = []; isEditingId = false;
  document.getElementById("reader").style.display = "none";
  document.getElementById("parcelId").innerText = "-";
  document.getElementById("count").innerText = "0";
  document.getElementById("itemList").innerHTML = "";
  document.getElementById("editParcelBtn").style.display = "none";
  document.getElementById("statusLabel").innerText = "‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà...";
  document.getElementById("statusLabel").className = "status-badge bg-light text-muted";
  const startBtn = document.getElementById("startBtn");
  startBtn.style.display = "block";
  startBtn.disabled = false;
  startBtn.innerText = "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö / ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
  document.getElementById("action-buttons").style.display = "none";
}

function renderList() {
  let ul = document.getElementById("itemList");
  ul.innerHTML = "";
  [...items].reverse().forEach((c, i) => {
    let li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center animate__animated animate__slideInLeft";
    li.innerHTML = `<span>üå∏ ${productMap[c] || c}</span> <button class="btn btn-sm text-danger" onclick="removeItem(${items.length - 1 - i})">‚úï</button>`;
    ul.appendChild(li);
  });
}

function removeItem(idx) {
  items.splice(idx, 1);
  document.getElementById("count").innerText = items.length;
  renderList();
  speak("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
}

function openTab(tab, btn) {
  document.querySelectorAll('#scan, #search, #dash').forEach(el => el.style.display = 'none');
  document.getElementById(tab).style.display = 'block';
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (tab === 'dash') refreshDash(); 
  if (tab !== 'search' && typeof searchScanner !== 'undefined' && searchScanner) { 
    searchScanner.clear(); 
    document.getElementById("search-reader").style.display = "none"; 
  }
}

function refreshDash() {
  const pids = Object.keys(sessionParcels);
  document.getElementById("d-box").innerText = pids.length;
  document.getElementById("d-item").innerText = Object.values(sessionParcels).reduce((a, b) => a + b, 0);
}

function resetSession() {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô?")) { 
    sessionParcels = {}; 
    refreshDash(); 
  }
}

function startSearchScan() {
  const readerDiv = document.getElementById("search-reader");
  readerDiv.style.display = "block";
  if (typeof searchScanner !== 'undefined' && searchScanner) searchScanner.clear();
  searchScanner = new Html5QrcodeScanner("search-reader", { fps: 15, qrbox: { width: 250, height: 250 } });
  searchScanner.render((text) => {
    document.getElementById("searchInput").value = text;
    speak("‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏∞");
    searchScanner.clear().then(() => {
      readerDiv.style.display = "none";
      runSearch(); 
    });
  });
}

function handleEnter(e) {
  if (e.key === "Enter") {
    runSearch();
  }
}

function runSearch() {
  const q = document.getElementById("searchInput").value.trim();
  if (!q) return;
  
  document.getElementById("loadingSearch").style.display = "block";
  document.getElementById("resultBody").innerHTML = ""; 

  google.script.run.withSuccessHandler(res => {
    document.getElementById("loadingSearch").style.display = "none";
    const tb = document.getElementById("resultBody");
    const th = document.getElementById("tableHead");
    tb.innerHTML = ""; th.innerHTML = "";
    
    if(!res || res.length === 0) {
      tb.innerHTML = "<tr><td colspan='2' class='text-center py-4 text-muted'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó Orders<br><small>‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small></td></tr>";
      speak("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞");
      return;
    }

    const max = Math.max(...res.map(r => r.length));
    let head = "<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏</th><th>‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</th>";
    for(let i=3; i<max; i++) head += `<th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${i-2}</th>`;
    th.innerHTML = head + "</tr>";

    res.forEach(row => {
      let tr = "<tr>";
      row.forEach(cell => {
        const content = cell.toString().includes("http") ? `<a href="${cell}" target="_blank" class="btn btn-sm btn-outline-primary">‡∏î‡∏π‡∏Ñ‡∏•‡∏¥‡∏õ</a>` : cell;
        tr += `<td>${content}</td>`;
      });
      tb.innerHTML += tr + "</tr>";
    });

    const latest = res[0]; 
    const rawItems = latest.slice(3).filter(i => i && i.toString().trim() !== "" && !i.toString().includes("http"));
    
    const itemNames = rawItems.map(sku => productMap[sku] || sku);
    const count = itemNames.length;
    if (count > 0) {
      speak(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞`);
    } else {
      speak("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞");
    }
  }).searchData(q); 
}
</script>
</body>
</html>