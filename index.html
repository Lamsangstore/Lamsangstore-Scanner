<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Permissions-Policy" content="camera=*">
  <title>üê± Lamsangstore Scanner</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZjY5YjQ7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmODVjMjtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9InNoaW5lR3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZmZmZmO3N0b3Atb3BhY2l0eTowLjM1IiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmZmZmY7c3RvcC1vcGFjaXR5OjAiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KCiAgPCEtLSDguJ7guLfguYnguJnguKvguKXguLHguIfguIHguKXguKEgLS0+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDgiIGZpbGw9InVybCgjYmdHcmFkKSIgLz4KICA8IS0tIHNoaW5lIG92ZXJsYXkgLS0+CiAgPGVsbGlwc2UgY3g9IjUwIiBjeT0iMzAiIHJ4PSIzMCIgcnk9IjIwIiBmaWxsPSJ1cmwoI3NoaW5lR3JhZCkiIC8+CgogIDwhLS0g4LiB4Lil4LmI4Lit4LiH4Lie4Lix4Liq4LiU4Li4IC0tPgogIDxyZWN0IHg9IjIyIiB5PSI0MiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjM4IiByeD0iNSIgcnk9IjUiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuOTUiLz4KICA8IS0tIOC4neC4suC4geC4peC5iOC4reC4hyAtLT4KICA8cGF0aCBkPSJNMjAgNDQgUTUwIDM2IDgwIDQ0IEw4MCA0MiBRNTAgMzIgMjAgNDIgWiIgZmlsbD0iI2ZmZTBmMCIgb3BhY2l0eT0iMC45Ii8+CiAgPHBhdGggZD0iTTIwIDQyIEw1MCAzNCBMODAgNDIiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmNjliNCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CiAgPCEtLSDguYDguKrguYnguJnguIHguKXguLLguIfguJ3guLIgLS0+CiAgPGxpbmUgeDE9IjUwIiB5MT0iMzQiIHgyPSI1MCIgeTI9IjQ0IiBzdHJva2U9IiNmZjY5YjQiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtZGFzaGFycmF5PSIyLDIiLz4KICA8IS0tIHJpYmJvbiDguJrguJnguIHguKXguYjguK3guIcgLS0+CiAgPHJlY3QgeD0iNDQiIHk9IjQyIiB3aWR0aD0iMTIiIGhlaWdodD0iMzgiIHJ4PSIyIiBmaWxsPSIjZmZiNmQ5IiBvcGFjaXR5PSIwLjUiLz4KICA8IS0tIOC5guC4muC4p+C5jCAtLT4KICA8cGF0aCBkPSJNNTAgMzggUTQyIDMyIDM4IDM1IFE0MiAzOCA1MCAzOCIgZmlsbD0iI2ZmNjliNCIvPgogIDxwYXRoIGQ9Ik01MCAzOCBRNTggMzIgNjIgMzUgUTU4IDM4IDUwIDM4IiBmaWxsPSIjZmY2OWI0Ii8+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSIzOCIgcj0iMyIgZmlsbD0iI2ZmZiIgc3Ryb2tlPSIjZmY2OWI0IiBzdHJva2Utd2lkdGg9IjEiLz4KCiAgPCEtLSDguJTguLLguKfguYDguKXguYfguIHguYYgLS0+CiAgPHRleHQgeD0iMTgiIHk9IjM4IiBmb250LXNpemU9IjkiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuOSI+4pymPC90ZXh0PgogIDx0ZXh0IHg9Ijc0IiB5PSIzNiIgZm9udC1zaXplPSI3IiBmaWxsPSIjZmZmIiBvcGFjaXR5PSIwLjgiPuKcpjwvdGV4dD4KICA8dGV4dCB4PSIyNiIgeT0iODIiIGZvbnQtc2l6ZT0iNiIgZmlsbD0iI2ZmNjliNCIgb3BhY2l0eT0iMC42Ij7inKY8L3RleHQ+CgogIDwhLS0g4LiV4Lix4Lin4Lit4Lix4LiB4Lip4LijIEwgLS0+CiAgPHRleHQgeD0iNTAiIHk9IjcyIiAKICAgICAgICBmb250LWZhbWlseT0iR2VvcmdpYSwgc2VyaWYiIAogICAgICAgIGZvbnQtc2l6ZT0iMjIiIAogICAgICAgIGZvbnQtd2VpZ2h0PSJib2xkIgogICAgICAgIGZpbGw9IiNmZjY5YjQiCiAgICAgICAgdGV4dC1hbmNob3I9Im1pZGRsZSIKICAgICAgICBsZXR0ZXItc3BhY2luZz0iMSI+TDwvdGV4dD4KPC9zdmc+Cg==">

  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --pink:        #ff8fab;
      --pink-light:  #ffccd5;
      --pink-pale:   #fff0f3;
      --peach:       #ffd6a5;
      --lilac:       #c8b6ff;
      --mint:        #b9fbc0;
      --cream:       #fff8f0;
      --brown:       #8b5e52;
      --text:        #5a3e4b;
      --card-bg:     rgba(255,255,255,0.82);
    }

    * { box-sizing: border-box; }

    body {
      background: var(--pink-pale);
      font-family: 'Mitr', 'Sarabun', sans-serif;
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* === ANIMATED BACKGROUND === */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: -2;
      background:
        radial-gradient(ellipse 80% 60% at 10% 10%, #ffe0ec 0%, transparent 60%),
        radial-gradient(ellipse 60% 50% at 90% 90%, #f0d9ff 0%, transparent 60%),
        radial-gradient(ellipse 50% 40% at 50% 50%, #fff0d6 0%, transparent 70%);
    }

    /* === FLOATING PAWS BACKGROUND === */
    .paw-bg { position: fixed; inset: 0; z-index: -1; overflow: hidden; pointer-events: none; }
    .paw { position: absolute; font-size: 1.4rem; opacity: 0.07; animation: floatPaw linear infinite; }
    @keyframes floatPaw {
      0%   { transform: translateY(110vh) rotate(0deg); opacity: 0; }
      10%  { opacity: 0.07; }
      90%  { opacity: 0.07; }
      100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
    }

    /* === CAT MASCOT === */
    .cat-mascot {
      width: 64px; height: 64px;
      position: relative; display: inline-block;
      animation: catBounce 2.5s ease-in-out infinite;
      cursor: pointer; filter: drop-shadow(0 4px 12px rgba(255,143,171,0.4));
    }
    @keyframes catBounce {
      0%, 100% { transform: translateY(0) rotate(-2deg); }
      50%       { transform: translateY(-8px) rotate(2deg); }
    }
    .cat-mascot:active { animation: catSpin 0.4s ease; }
    @keyframes catSpin {
      0%   { transform: rotate(0deg) scale(1); }
      50%  { transform: rotate(180deg) scale(1.2); }
      100% { transform: rotate(360deg) scale(1); }
    }

    /* heartbeat on tap */
    .cat-heart {
      position: absolute; top: -12px; right: -8px;
      font-size: 0.9rem; opacity: 0;
      animation: heartPop 0s;
      pointer-events: none;
    }
    .cat-heart.show { animation: heartPop 0.8s ease forwards; }
    @keyframes heartPop {
      0%   { opacity: 0; transform: scale(0) translateY(0); }
      40%  { opacity: 1; transform: scale(1.3) translateY(-6px); }
      100% { opacity: 0; transform: scale(0.8) translateY(-18px); }
    }

    /* === HEADER === */
    #app-header {
      text-align: center;
      padding: 10px 0 4px;
      position: relative;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--pink);
      letter-spacing: 0.5px;
      margin: 4px 0 2px;
      text-shadow: 0 2px 8px rgba(255,143,171,0.25);
    }
    .header-sub {
      font-size: 0.75rem;
      color: #c49aaa;
      margin: 0;
    }

    /* === TAB BAR === */
    .tab-bar {
      display: flex;
      justify-content: space-around;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      padding: 6px;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(255,143,171,0.15);
      margin-bottom: 18px;
      border: 1.5px solid rgba(255,204,213,0.5);
    }
    .tab-btn {
      border: none;
      background: transparent;
      padding: 10px 16px;
      border-radius: 18px;
      font-weight: 500;
      font-size: 0.85rem;
      color: #c49aaa;
      transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
      font-family: 'Mitr', sans-serif;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--pink), #ff6b9d);
      color: white;
      box-shadow: 0 4px 16px rgba(255,107,157,0.4);
      transform: scale(1.05);
    }
    .tab-btn:hover:not(.active) { color: var(--pink); transform: scale(1.03); }

    /* === CARDS === */
    .card {
      border-radius: 28px;
      border: 1.5px solid rgba(255,204,213,0.4);
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      box-shadow: 0 8px 32px rgba(255,143,171,0.1);
      transition: box-shadow 0.3s;
    }
    .card:hover { box-shadow: 0 12px 40px rgba(255,143,171,0.18); }

    /* === SCANNER === */
    #reader, #search-reader {
      width: 100%; max-width: 440px; margin: auto;
      border-radius: 22px; overflow: hidden;
      border: 5px solid white;
      box-shadow: 0 0 0 3px var(--pink-light), 0 8px 24px rgba(255,143,171,0.2);
    }

    /* === BUTTONS === */
    .btn-custom {
      border-radius: 22px;
      padding: 14px;
      font-weight: 600;
      font-size: 0.95rem;
      border: none;
      transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
      font-family: 'Mitr', sans-serif;
      letter-spacing: 0.3px;
    }
    .btn-custom:hover { transform: translateY(-2px); filter: brightness(1.05); }
    .btn-custom:active { transform: scale(0.97); }

    .btn-main {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      color: white;
      box-shadow: 0 4px 16px rgba(9,132,227,0.3);
    }
    .btn-save {
      background: linear-gradient(135deg, var(--pink), #e84393);
      color: white;
      box-shadow: 0 4px 16px rgba(255,143,171,0.4);
    }
    .btn-cancel {
      background: linear-gradient(135deg, #b2bec3, #636e72);
      color: white;
    }

    /* === STATUS BADGE === */
    .status-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-top: 10px;
      transition: all 0.4s ease;
    }

    /* === REC UI === */
    #rec-ui {
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(255,240,243,0.8), rgba(255,248,240,0.8));
      border: 1.5px solid rgba(255,204,213,0.5) !important;
      border-radius: 18px !important;
    }
    #video-preview { display: none; }
    .rec-indicator { display: flex; align-items: center; font-size: 13px; font-weight: 500; color: var(--brown); }
    .rec-dot {
      width: 10px; height: 10px;
      background: var(--pink);
      border-radius: 50%;
      margin-right: 8px;
      animation: blink 1s infinite;
      box-shadow: 0 0 6px var(--pink);
    }
    @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.2; } }

    /* === LIST ITEMS === */
    .list-group-item {
      border: none;
      background: linear-gradient(135deg, #fff0f3, #fff8ff);
      margin-bottom: 8px;
      border-radius: 16px !important;
      padding: 12px 16px;
      border-left: 3px solid var(--pink-light) !important;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    .list-group-item:hover { transform: translateX(3px); border-left-color: var(--pink) !important; }

    /* === EDIT BUTTON === */
    .btn-edit-inline {
      padding: 2px 10px; font-size: 0.72rem;
      border-radius: 10px; margin-left: 8px;
      border: 1.5px solid var(--pink-light);
      background: white; color: var(--pink);
      transition: all 0.2s;
    }
    .btn-edit-inline:hover { background: var(--pink-light); }

    /* === UPLOAD BUTTON === */
    .btn-upload-head {
      position: absolute; top: 0; right: 0;
      border-radius: 20px; font-weight: 500;
      font-size: 0.8rem;
      background: white;
      border: 1.5px solid var(--pink-light) !important;
      color: var(--pink) !important;
      box-shadow: 0 2px 10px rgba(255,143,171,0.2);
      transition: all 0.2s;
    }
    .btn-upload-head:hover { background: var(--pink); color: white !important; }

    /* === CHECKLIST === */
    .order-checklist {
      background: linear-gradient(135deg, #fff8ff, #fff0f3);
      border-radius: 18px;
      padding: 14px;
      border: 2px dashed var(--pink-light) !important;
      margin-top: 14px;
      display: none;
    }
    .checklist-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 10px; border-bottom: 1px solid #ffe4ec;
      font-size: 0.88rem; border-radius: 8px; margin-bottom: 2px;
      transition: background 0.2s;
    }
    .checklist-item.matched { background: #e8fff0; color: #27ae60; font-weight: 600; border-left: 3px solid #2ecc71; }
    .checklist-item.over    { background: #fff0f0; color: #c0392b; font-weight: 600; border-left: 3px solid #e74c3c; }

    /* === REMARK PANEL === */
    .remark-panel {
      background: linear-gradient(135deg, #fffbeb, #fff8e1);
      border-radius: 16px; padding: 12px;
      border: 2px solid #ffd166; margin-top: 10px; display: none;
    }
    .remark-btn {
      border-radius: 20px; padding: 6px 14px;
      font-size: 0.8rem; font-weight: 500; margin: 3px;
      border: 2px solid #ffd166; background: white;
      cursor: pointer; transition: all 0.2s;
      font-family: 'Mitr', sans-serif;
    }
    .remark-btn:hover, .remark-btn.selected { background: #ffd166; border-color: #ffd166; color: #5a3e00; }

    /* === PARCEL INFO BOX === */
    .parcel-box {
      background: linear-gradient(135deg, rgba(255,240,243,0.7), rgba(255,248,255,0.7));
      border: 1.5px solid var(--pink-light);
      border-radius: 20px;
      padding: 14px;
    }

    /* === CAT PAW SPARKLE on scan === */
    .paw-sparkle {
      position: fixed;
      pointer-events: none;
      font-size: 1.6rem;
      z-index: 9999;
      animation: pawFly 0.7s ease forwards;
    }
    @keyframes pawFly {
      0%   { opacity: 1; transform: scale(0.5) rotate(-20deg) translateY(0); }
      100% { opacity: 0; transform: scale(1.5) rotate(20deg) translateY(-60px); }
    }

    /* === MODAL === */
    .modal-content {
      border-radius: 24px !important;
      border: 1.5px solid var(--pink-light);
      backdrop-filter: blur(16px);
    }
    .modal-header {
      background: linear-gradient(135deg, var(--pink), #ff6b9d) !important;
      border-radius: 22px 22px 0 0 !important;
    }

    /* === DASHBOARD CARDS === */
    .stat-card {
      border-radius: 24px;
      padding: 20px;
      background: var(--card-bg);
      border: 1.5px solid var(--pink-light);
      text-align: center;
      backdrop-filter: blur(12px);
    }
    .stat-num {
      font-size: 3rem; font-weight: 600;
      background: linear-gradient(135deg, var(--pink), #b57bee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* === SCROLLBAR === */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--pink-pale); }
    ::-webkit-scrollbar-thumb { background: var(--pink-light); border-radius: 10px; }

    /* === ANIMATE IN === */
    .fade-in-up {
      animation: fadeInUp 0.5s ease both;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* refresh button */
    #refreshCacheBtn {
      border-radius: 18px !important;
      border: 1.5px solid var(--pink-light) !important;
      color: var(--pink) !important;
      font-family: 'Mitr', sans-serif;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    #refreshCacheBtn:hover { background: var(--pink-light) !important; }
  </style>
</head>
<body>
<canvas id="overlayCanvas" style="display:none;"></canvas>

<div class="container mt-4 pb-5">
  <!-- Floating paw background -->
  <div class="paw-bg" id="pawBg"></div>

  <div id="app-header" class="text-center mb-3 fade-in-up" style="position: relative;">
    <button class="btn btn-sm btn-upload-head shadow-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">üì• ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>

    <!-- Cat Mascot SVG -->
    <div style="margin-bottom: 4px;" onclick="catTap(this)">
      <div class="cat-mascot" style="display:inline-block;">
        <svg viewBox="0 0 64 64" width="64" height="64" xmlns="http://www.w3.org/2000/svg">
          <!-- ‡∏´‡∏π -->
          <polygon points="10,22 6,6 22,16" fill="#ffb6c1"/>
          <polygon points="54,22 58,6 42,16" fill="#ffb6c1"/>
          <polygon points="11,20 8,9 20,17" fill="#ff8fab"/>
          <polygon points="53,20 56,9 44,17" fill="#ff8fab"/>
          <!-- ‡∏´‡∏±‡∏ß -->
          <ellipse cx="32" cy="34" rx="22" ry="20" fill="#fff0f3"/>
          <!-- ‡πÅ‡∏Å‡πâ‡∏° blush -->
          <ellipse cx="18" cy="38" rx="5" ry="3.5" fill="#ffccd5" opacity="0.7"/>
          <ellipse cx="46" cy="38" rx="5" ry="3.5" fill="#ffccd5" opacity="0.7"/>
          <!-- ‡∏ï‡∏≤ -->
          <ellipse cx="24" cy="32" rx="4" ry="4.5" fill="#5a3e4b"/>
          <ellipse cx="40" cy="32" rx="4" ry="4.5" fill="#5a3e4b"/>
          <circle cx="25.5" cy="30.5" r="1.3" fill="white"/>
          <circle cx="41.5" cy="30.5" r="1.3" fill="white"/>
          <!-- ‡∏à‡∏°‡∏π‡∏Å -->
          <ellipse cx="32" cy="39" rx="2.5" ry="2" fill="#ff8fab"/>
          <!-- ‡∏õ‡∏≤‡∏Å -->
          <path d="M29 41 Q32 44 35 41" fill="none" stroke="#ff8fab" stroke-width="1.2" stroke-linecap="round"/>
          <!-- ‡∏´‡∏ô‡∏ß‡∏î -->
          <line x1="10" y1="38" x2="26" y2="39.5" stroke="#d4a0b0" stroke-width="1" opacity="0.7"/>
          <line x1="10" y1="41" x2="26" y2="41" stroke="#d4a0b0" stroke-width="1" opacity="0.7"/>
          <line x1="38" y1="39.5" x2="54" y2="38" stroke="#d4a0b0" stroke-width="1" opacity="0.7"/>
          <line x1="38" y1="41" x2="54" y2="41" stroke="#d4a0b0" stroke-width="1" opacity="0.7"/>
          <!-- ‡πÇ‡∏ö‡∏ß‡πå -->
          <path d="M32 18 Q26 13 22 16 Q26 19 32 18" fill="#ff8fab"/>
          <path d="M32 18 Q38 13 42 16 Q38 19 32 18" fill="#ff8fab"/>
          <circle cx="32" cy="18" r="2.5" fill="white" stroke="#ff8fab" stroke-width="1"/>
        </svg>
        <div class="cat-heart" id="catHeart">üíï</div>
      </div>
    </div>

    <h1 class="header-title">üå∏ Lamsangstore Scanner</h1>
    <p class="header-sub">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏û‡πá‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‚ú¶ ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ ‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à</p>
  </div>

  <div id="app-tabs" class="tab-bar">
    <button class="tab-btn active" onclick="openTab('scan', this)">üêæ ‡∏™‡πÅ‡∏Å‡∏ô</button>
    <button class="tab-btn" onclick="openTab('search', this)">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    <button class="tab-btn" onclick="openTab('dash', this)">üéÄ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <!-- TAB: SCAN -->
  <div id="scan" class="animate__animated animate__fadeIn">
    <div class="card p-4 text-center">
      <div id="rec-ui" class="mb-3 p-2 border rounded-4 bg-light shadow-sm">
        <div id="rec-status">
          <span id="rec-label" style="color:#c49aaa; font-size:0.82rem; font-weight:500;">üê± ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞</span>
        </div>
        <video id="video-preview" autoplay playsinline muted></video>
      </div>

      <button id="startBtn" onclick="initScanner()" class="btn-custom btn-main mb-3 w-100 shadow">üêæ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö / ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <button id="refreshCacheBtn" onclick="refreshProductCache()" class="btn btn-outline-secondary btn-sm mb-2" style="display:none; border-radius:15px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <div id="reader" style="display:none"></div>

      <div id="orderChecklistPanel" class="order-checklist text-start shadow-sm mb-3">
        <h6 class="fw-bold mb-2" style="color:var(--pink)">üêæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏û‡πá‡∏Å</h6>
        <div id="checklistContent"></div>
        <div id="orderStatusAlert" class="alert mt-2 mb-0 py-2" style="display:none; font-size: 0.85rem;"></div>

        <!-- Remark Panel: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö -->
        <div id="remarkPanel" class="remark-panel">
          <p class="mb-2 fw-bold small text-warning-emphasis">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</p>
          <div id="remarkButtons">
            <button class="remark-btn" onclick="selectRemark(this, '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î')">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</button>
            <button class="remark-btn" onclick="selectRemark(this, '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ')">üé® ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ</button>
            <button class="remark-btn" onclick="selectRemark(this, '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∏‡πà‡∏ô')">üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∏‡πà‡∏ô</button>
            <button class="remark-btn" onclick="selectRemark(this, '‡∏≠‡∏∑‡πà‡∏ô‡πÜ')">‚úèÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
          </div>
          <div id="remarkOtherBox" style="display:none; margin-top:8px;">
            <input id="remarkOtherInput" class="form-control form-control-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." style="border-radius:10px;">
          </div>
          <button onclick="confirmRemarkAndFinish()" class="btn btn-warning btn-sm mt-2 w-100 fw-bold" style="border-radius:15px;">
            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏á‡∏≤‡∏ô
          </button>
        </div>
      </div>

      <div class="parcel-box mt-3">
        <div class="row align-items-center">
          <div class="col-7 text-start" style="border-right: 1.5px solid var(--pink-light);">
            <div class="small mb-1" style="color:#c49aaa; font-weight:500;">üê± ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <div class="d-flex align-items-center">
              <span id="parcelId" style="font-weight:600; color:var(--pink); font-size:1rem;">-</span>
              <button id="editParcelBtn" onclick="editParcelId()" class="btn btn-edit-inline" style="display:none">‚úèÔ∏è</button>
            </div>
          </div>
          <div class="col-5 text-center">
            <div class="small mb-1" style="color:#c49aaa; font-weight:500;">üéÄ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
            <div id="count" style="font-size:1.8rem; font-weight:600; color:var(--pink);">0</div>
          </div>
        </div>
      </div>

      <div id="statusLabel" class="status-badge bg-light text-muted">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</div>

      <div class="mt-3 text-start">
        <h6 class="fw-bold ms-1 mb-2" style="color:var(--brown);">üéÅ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</h6>
        <ul id="itemList" class="list-group"></ul>
      </div>

      <div id="action-buttons" class="mt-4" style="display:none">
        <div class="row g-2">
          <div class="col-8">
            <button id="saveBtn" onclick="finishWork(true)" class="btn-custom btn-save w-100 shadow">üéÄ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
          <div class="col-4">
            <button id="cancelBtn" onclick="cancelWork()" class="btn-custom btn-cancel w-100 shadow">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: SEARCH -->
  <div id="search" style="display:none" class="animate__animated animate__fadeIn">
    <div class="card p-4">
      <div class="mb-3">
        <div id="search-reader" style="display:none; margin-bottom: 15px;"></div>
        <div class="input-group">
          <input id="searchInput" class="form-control rounded-start-4 p-3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏..." onkeypress="handleEnter(event)">
          <button class="btn btn-primary px-3" onclick="startSearchScan()" title="‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á">üì∑</button>
          <button class="btn btn-success rounded-end-4 px-4" onclick="runSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
        <div class="form-text text-muted ms-2 small">üí° ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏ç‡πà</div>
      </div>
      <div id="loadingSearch" class="text-center my-3" style="display:none">
        <div class="spinner-border text-primary"></div>
        <p class="small text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>
      </div>
      <div class="table-responsive">
        <table class="table table-hover small">
          <thead id="tableHead" class="table-light"></thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB: DASHBOARD -->
  <div id="dash" style="display:none" class="fade-in-up">
    <div class="row g-3 text-center mb-3">
      <div class="col-6">
        <div class="stat-card">
          <div style="font-size:2rem;">üì¶</div>
          <div class="small text-muted mb-1">‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>
          <div id="d-box" class="stat-num">0</div>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card">
          <div style="font-size:2rem;">üéÄ</div>
          <div class="small text-muted mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>
          <div id="d-item" class="stat-num">0</div>
        </div>
      </div>
    </div>
    <div class="text-center">
      <button class="btn btn-sm" onclick="resetSession()"
        style="border-radius:16px; border:1.5px solid var(--pink-light); color:var(--pink); background:white; font-family:Mitr,sans-serif;">
        üêæ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
      </button>
    </div>
  </div>
</div>

<!-- Modal ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border-radius: 20px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-pink), var(--accent-blue)); color: white; border-radius: 20px 20px 0 0;">
        <h5 class="modal-title fw-bold">üì• ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (Marketplace)</label>
          <select id="marketplaceSelect" class="form-select border-primary">
            <option value="tiktok">Tiktok (Tracking=AJ, SKU=G)</option>
            <option value="shopee">Shopee (Tracking=N, SKU=S)</option>
            <option value="lazada">Lazada (Tracking=BG, SKU=F)</option>
            <option value="page365">Page365 (Tracking=L, SKU=Y)</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (.xlsx, .csv)</label>
          <input type="file" id="fileInput" class="form-control" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" style="border-radius: 10px;" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary" style="border-radius: 10px; background-color: var(--primary-pink); border: none;" onclick="processFileUpload()">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ============================================================
// ‚öôÔ∏è CONFIG: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏Ñ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß!
// ============================================================
const GAS_URL = "https://script.google.com/macros/s/AKfycbyF-lL7HuILWULf6EjLd0ocKuhQc7ahkXxS0QFt2DeuCkaW6mxDeVePofiNgC3YMMijGg/exec";
// ============================================================

// col index = ‡πÄ‡∏•‡∏Ç column - 1 (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0)
const colMappings = {
  'tiktok':  { tracking: 35, sku: 6,  qty: 9,  headerRows: 1 }, // AJ=36, G=7, J=10
  'shopee':  { tracking: 13, sku: 18, qty: 22, headerRows: 1 }, // N=14, S=19, W=23
  'lazada':  { tracking: 58, sku: 5,  qty: -1, headerRows: 1 }, // BG=59, F=6, ‡πÑ‡∏°‡πà‡∏°‡∏µ qty (1row=1‡∏ä‡∏¥‡πâ‡∏ô)
  'page365': { tracking: 11, sku: 24, qty: 28, headerRows: 1, isCsv: true } // L=12, Y=25, AC=29
};

// --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å ---
let productMap = {}, currentP = "", items = [], scanner, searchScanner, lastScanTime = 0;
let sessionParcels = {}, scanBuffer = [], bufferTimeout = null, isFinishing = false, isEditingId = false;
let expectedItemsArray = [], scannedItemsMap = {}, isStrictValidationMode = false;
let currentRemark = ''; // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
let mediaRecorder, recordedChunks = [], cameraStream = null, isRecording = false;

// --- API Helper: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà google.script.run ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
async function callGAS(action, payload = {}) {
  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({ action, ...payload })
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return text; }
}

// --- Speech ---
function speak(t, priority = true) {
  if (!window.speechSynthesis) return;
  if (priority) speechSynthesis.cancel();
  const m = new SpeechSynthesisUtterance(t);
  m.lang = "th-TH"; m.rate = 1.3;
  speechSynthesis.speak(m);
}

// --- ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ---
async function startCameraRecording() {
  if (isRecording) return;
  const videoEl = document.getElementById('video-preview');
  const canvas = document.getElementById('overlayCanvas');
  const ctx = canvas.getContext('2d');
  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    videoEl.srcObject = cameraStream;
    await videoEl.play();
    canvas.width = videoEl.videoWidth || 640;
    canvas.height = videoEl.videoHeight || 480;
    recordedChunks = [];

    function drawOverlay() {
      if (!isRecording && !cameraStream) return;
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
      const overlayHeight = 160 + items.length * 26;
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, overlayHeight);
      ctx.fillStyle = "#ffffff";
      ctx.font = "22px sans-serif";
      const now = new Date().toLocaleString("th-TH");
      let y = canvas.height - overlayHeight + 30;
      ctx.fillText("üìÖ " + now, 20, y); y += 30;
      ctx.fillText("üì¶ ‡∏û‡∏±‡∏™‡∏î‡∏∏: " + (currentP || "-"), 20, y); y += 30;
      ctx.fillText("üßæ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: " + items.length + " ‡∏ä‡∏¥‡πâ‡∏ô", 20, y);
      ctx.font = "20px sans-serif";
      items.forEach(sku => { y += 26; ctx.fillText("- " + (productMap[sku] || sku), 40, y); });
      requestAnimationFrame(drawOverlay);
    }
    drawOverlay();

    const canvasStream = canvas.captureStream(30);
    mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 2500000 });
    mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.start();
    isRecording = true;
    document.getElementById('rec-label').innerHTML = '<div class="rec-indicator"><span class="rec-dot"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</div>';
  } catch (err) {
    console.error("Camera error:", err);
    document.getElementById('rec-label').innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err.message;
  }
}

function stopCameraRecording() {
  return new Promise((resolve) => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
      resolve([]); return;
    }
    mediaRecorder.addEventListener('stop', () => {
      isRecording = false;
      const snapshot = [...recordedChunks];
      if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
      document.getElementById('rec-label').innerText = "üî¥ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
      resolve(snapshot);
    }, { once: true });
    mediaRecorder.stop();
  });
}

async function convertChunksToBase64(chunks) {
  if (!chunks || chunks.length === 0) return "";
  const blob = new Blob(chunks, { type: 'video/webm' });
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      if (!reader.result || typeof reader.result !== 'string') { resolve(""); return; }
      const idx = reader.result.indexOf(',');
      resolve(idx > -1 ? reader.result.slice(idx + 1) : "");
    };
    reader.onerror = () => resolve("");
    reader.readAsDataURL(blob);
  });
}

// --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö ---
async function initScanner() {
  const btn = document.getElementById("startBtn");
  const CACHE_KEY = "productMap_cache";
  const CACHE_TIME_KEY = "productMap_time";
  const CACHE_TTL = 60 * 60 * 1000; // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

  // ‡πÇ‡∏´‡∏•‡∏î cache ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢ ‚Äî ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÑ‡∏°‡πà‡∏£‡∏≠ GAS
  const cached = localStorage.getItem(CACHE_KEY);
  const cachedTime = parseInt(localStorage.getItem(CACHE_TIME_KEY) || "0");
  const isFresh = (Date.now() - cachedTime) < CACHE_TTL;

  if (cached) {
    productMap = JSON.parse(cached);
    document.getElementById("app-header").style.display = "none";
    document.getElementById("app-tabs").style.display = "none";
    btn.style.display = "none";
    document.getElementById("action-buttons").style.display = "block";
    document.getElementById("refreshCacheBtn").style.display = "inline-block";
    speak("‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
    startScan();

    // refresh ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πâ‡∏≤ cache ‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    if (!isFresh) {
      callGAS("getProductData").then(res => {
        if (res && Object.keys(res).length > 0) {
          productMap = res;
          localStorage.setItem(CACHE_KEY, JSON.stringify(res));
          localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
          console.log("[Cache] ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
        }
      }).catch(() => {});
    }
    return;
  }

  // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ cache ‚Äî ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
  btn.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
  btn.disabled = true;
  try {
    const res = await callGAS("getProductData");
    productMap = res || {};
    // ‡πÄ‡∏Å‡πá‡∏ö cache
    localStorage.setItem(CACHE_KEY, JSON.stringify(productMap));
    localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
    document.getElementById("app-header").style.display = "none";
    document.getElementById("app-tabs").style.display = "none";
    btn.style.display = "none";
    document.getElementById("action-buttons").style.display = "block";
    document.getElementById("refreshCacheBtn").style.display = "inline-block";
    speak("‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
    startScan();
  } catch (err) {
    btn.innerText = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
    btn.disabled = false;
    Swal.fire('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GAS_URL ‡πÉ‡∏ô index.html\n\n' + err.message, 'error');
  }
}

async function refreshProductCache() {
  const btn = document.getElementById("refreshCacheBtn");
  btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...";
  btn.disabled = true;
  try {
    const res = await callGAS("getProductData");
    if (res && Object.keys(res).length > 0) {
      productMap = res;
      localStorage.setItem("productMap_cache", JSON.stringify(res));
      localStorage.setItem("productMap_time", Date.now().toString());
      btn.innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß";
      setTimeout(() => { btn.innerText = "üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"; btn.disabled = false; }, 2000);
    }
  } catch (e) {
    btn.innerText = "‚ùå ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
    btn.disabled = false;
  }
}

function startScan() {
  document.getElementById("reader").style.display = "block";
  if (!scanner) {
    scanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: { width: 300, height: 350 }, rememberLastUsedCamera: true });
    scanner.render((text, result) => onScanBuffer(text, result));
  }
}

function onScanBuffer(text, result) {
  const now = Date.now();
  if (isFinishing || now - lastScanTime < 2500) return;
  let yPos = 9999;
  if (result && result.result && result.result.location) yPos = result.result.location.topLeftCorner.y;
  scanBuffer.push({ text, y: yPos });
  if (!bufferTimeout) {
    bufferTimeout = setTimeout(() => {
      scanBuffer.sort((a, b) => a.y - b.y);
      processFinalScan(scanBuffer[0].text);
      scanBuffer = []; bufferTimeout = null;
    }, 300);
  }
}

async function processFinalScan(text) {
  const upperText = text.trim().toUpperCase();
  const isFlash = upperText.startsWith("TH") && (upperText.length === 15 || upperText.length === 14);
  const isJT = /^\d{12}$/.test(upperText) || /^(81|82|83|86|JET)/.test(upperText);
  const isProduct = upperText.startsWith("B");

  if (isProduct) {
    if (!currentP && !isEditingId) { speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞"); return; }
    if (isStrictValidationMode) {
      let reqItem = expectedItemsArray.find(i => i.sku === upperText);
      let currentScannedQty = scannedItemsMap[upperText] || 0;
      if (!reqItem) speak("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞");
      else if (currentScannedQty >= reqItem.qty) speak("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡πà‡∏∞");
      scannedItemsMap[upperText] = currentScannedQty + 1;
    }
    lastScanTime = Date.now();
    items.push(upperText);
    document.getElementById("count").innerText = items.length;
    renderList();
    if (isStrictValidationMode) updateChecklistUI();
    speak(productMap[upperText] || upperText);
    setStatus("‚úî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: " + upperText, "success");
  } else if (isFlash || isJT) {
    lastScanTime = Date.now();
    const carrier = isFlash ? "‡πÅ‡∏ü‡∏•‡∏ä" : "‡πÄ‡∏à ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡∏ó‡∏µ";
    if (sessionParcels[upperText] && !isEditingId) {
      speak("‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
      setStatus("‚ùå ‡∏û‡∏±‡∏™‡∏î‡∏∏ " + upperText + " ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", "danger"); return;
    }
    if (upperText === currentP && !isEditingId) {
      if (items.length === 0) { speak("‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞"); setStatus("‚ö†Ô∏è ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á", "warning"); return; }
      speak("‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á");
      finishWork(false); return;
    }
    if (currentP && upperText !== currentP && !isEditingId) {
      speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞");
      setStatus("‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô", "danger"); return;
    }
    processNewParcel(upperText, carrier);
  } else {
    lastScanTime = Date.now();
    speak("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πà‡∏∞");
    setStatus("‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "warning");
  }
}

function setStatus(msg, type) {
  const el = document.getElementById("statusLabel");
  el.innerText = msg;
  const map = { success: "bg-success text-white", danger: "bg-danger text-white", warning: "bg-warning text-dark", primary: "bg-primary text-white", info: "bg-info text-white" };
  el.className = "status-badge " + (map[type] || "bg-light text-muted");
}

function editParcelId() {
  speak("‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞");
  isEditingId = true; currentP = "";
  document.getElementById("parcelId").innerText = "‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà...";
  setStatus("‚úèÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏...", "info");
  document.getElementById("editParcelBtn").style.display = "none";
}

function processNewParcel(text, carrier) {
  const wasEditing = isEditingId;
  currentP = text;
  if (!wasEditing) items = [];
  isEditingId = false;
  document.getElementById("parcelId").innerText = text;
  document.getElementById("count").innerText = items.length;
  renderList();
  setStatus((wasEditing ? "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏õ‡πá‡∏ô: " : `üì¶ ‡∏û‡∏±‡∏™‡∏î‡∏∏ ${carrier}: `) + text, "primary");
  document.getElementById("editParcelBtn").style.display = "inline-block";
  const lastFour = text.length >= 4 ? text.slice(-4) : text;
  if (wasEditing) speak(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™ ${lastFour.split('').join(' ')} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`);
  else {
    speak(`‡∏û‡∏±‡∏™‡∏î‡∏∏ ${carrier} ‡πÉ‡∏´‡∏°‡πà ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ ${lastFour.split('').join(' ')}`);
    startCameraRecording();   // ‡πÑ‡∏°‡πà await ‚Äî ‡∏ó‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
    checkExpectedItems(text); // ‡πÑ‡∏°‡πà await ‚Äî ‡∏ó‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
  }
}

async function cancelWork() {
  if (!currentP && items.length === 0) { await closeAppCompletely(); return; }
  if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)")) {
    isFinishing = true;
    speak("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞");
    await stopCameraRecording();
    recordedChunks = [];
    await resetAppForNext();
    isFinishing = false;
    setStatus("‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "secondary");
  }
}

async function finishWork(isManual = false) {
  const pId = currentP;
  if (!pId) { if (isManual) speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞"); return; }
  if (isStrictValidationMode && !validateCurrentOrder()) {
    // ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô ‚Äî ‡∏¢‡∏±‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
    let hasOver = false;
    for (let sSku in scannedItemsMap) {
      const req = expectedItemsArray.find(ex => ex.sku === sSku);
      if (!req || scannedItemsMap[sSku] > req.qty) { hasOver = true; break; }
    }
    if (hasOver) {
      Swal.fire('‡∏¢‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ!', '‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô', 'error');
      speak("‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"); return;
    }
    // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Äî ‡πÅ‡∏™‡∏î‡∏á remark panel ‡πÅ‡∏ó‡∏ô
    if (!currentRemark) {
      document.getElementById('remarkPanel').style.display = 'block';
      document.getElementById('orderChecklistPanel').scrollIntoView({ behavior: 'smooth' });
      speak("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô", false);
      return;
    }
  }
  isFinishing = true;
  const snapshotItems = [...items];
  const snapshotParcelId = pId;
  const videoChunks = await stopCameraRecording();
  const count = snapshotItems.length;
  const summaryMsg = count > 0 ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${count} ‡∏ä‡∏¥‡πâ‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞` : `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`;

  if (isManual) {
    await closeAppCompletely();
    speak(summaryMsg, false);
    setTimeout(() => { isFinishing = false; }, 1500);
  } else {
    await resetAppForNext();
    speak(summaryMsg + " ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞", false);
    setStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...", "light");
    setTimeout(() => {
      isFinishing = false;
      lastScanTime = Date.now();
      setStatus("‚úî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", "success");
    }, 1500);
  }

  sessionParcels[snapshotParcelId] = count;
  const snapshotRemark = currentRemark;
  processBackgroundUpload(snapshotParcelId, snapshotItems, videoChunks, snapshotRemark);
}

async function processBackgroundUpload(pId, itemsArr, chunks, remarkNote = '') {
  try {
    const videoData = await convertChunksToBase64(chunks);
    await callGAS("saveData", { parcelId: pId, items: itemsArr, videoEvidence: videoData || "no_video", remark: remarkNote || "" });
    console.log(`[Background] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${pId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  } catch (err) {
    console.error(`[Background Error] ${pId}:`, err);
  }
}

async function resetAppForNext() {
  currentP = ""; items = []; isEditingId = false;
  expectedItemsArray = []; scannedItemsMap = {}; isStrictValidationMode = false;
  resetRemark();
  document.getElementById("orderChecklistPanel").style.display = "none";
  document.getElementById("parcelId").innerText = "-";
  document.getElementById("count").innerText = "0";
  document.getElementById("itemList").innerHTML = "";
  document.getElementById("editParcelBtn").style.display = "none";
  setStatus("‡∏£‡∏≠‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà...", "light");
  document.getElementById("rec-label").innerText = "üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)";
}

async function closeAppCompletely() {
  if (scanner) { await scanner.clear(); scanner = null; }
  document.getElementById("app-header").style.display = "block";
  document.getElementById("app-tabs").style.display = "flex";
  currentP = ""; items = []; isEditingId = false;
  expectedItemsArray = []; scannedItemsMap = {}; isStrictValidationMode = false;
  resetRemark();
  document.getElementById("orderChecklistPanel").style.display = "none";
  document.getElementById("reader").style.display = "none";
  document.getElementById("parcelId").innerText = "-";
  document.getElementById("count").innerText = "0";
  document.getElementById("itemList").innerHTML = "";
  document.getElementById("editParcelBtn").style.display = "none";
  setStatus("‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà...", "light");
  const startBtn = document.getElementById("startBtn");
  startBtn.style.display = "block"; startBtn.disabled = false;
  startBtn.innerText = "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö / ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
  document.getElementById("action-buttons").style.display = "none";
}

function renderList() {
  let ul = document.getElementById("itemList");
  ul.innerHTML = "";
  [...items].reverse().forEach((c, i) => {
    let li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center animate__animated animate__slideInLeft";
    li.innerHTML = `<span>üå∏ ${productMap[c] || c}</span> <button class="btn btn-sm text-danger" onclick="removeItem(${items.length - 1 - i})">‚úï</button>`;
    ul.appendChild(li);
  });
}

function removeItem(idx) {
  if (isStrictValidationMode) {
    let sku = items[idx];
    if (scannedItemsMap[sku] > 0) scannedItemsMap[sku]--;
  }
  items.splice(idx, 1);
  document.getElementById("count").innerText = items.length;
  renderList();
  if (isStrictValidationMode) updateChecklistUI();
  speak("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
}

// --- Checklist ---
async function checkExpectedItems(tracking) {
  document.getElementById("orderChecklistPanel").style.display = "none";
  try {
    const expectedData = await callGAS("getExpectedOrderDetails", { trackingNo: tracking });
    if (expectedData && expectedData.length > 0) {
      isStrictValidationMode = true;
      expectedItemsArray = expectedData;
      scannedItemsMap = {};
      items.forEach(sku => { scannedItemsMap[sku] = (scannedItemsMap[sku] || 0) + 1; });
      document.getElementById("orderChecklistPanel").style.display = "block";
      updateChecklistUI();
      speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πà‡∏∞", false);
    } else {
      isStrictValidationMode = false; expectedItemsArray = []; scannedItemsMap = {};
    }
  } catch (e) {
    isStrictValidationMode = false;
  }
}

// --- Remark Functions ---
function selectRemark(btn, value) {
  document.querySelectorAll('.remark-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  currentRemark = value;
  const otherBox = document.getElementById('remarkOtherBox');
  if (value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
    otherBox.style.display = 'block';
    document.getElementById('remarkOtherInput').focus();
  } else {
    otherBox.style.display = 'none';
  }
}

async function confirmRemarkAndFinish() {
  if (!currentRemark) { speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞", false); return; }
  if (currentRemark === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
    const other = document.getElementById('remarkOtherInput').value.trim();
    if (!other) { speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞", false); return; }
    currentRemark = other;
  }
  document.getElementById('remarkPanel').style.display = 'none';
  speak(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ${currentRemark} ‡∏Ñ‡πà‡∏∞`, false);
  await finishWork(false); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å finishWork ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ currentRemark ‡πÅ‡∏•‡πâ‡∏ß
}

function resetRemark() {
  currentRemark = '';
  document.querySelectorAll('.remark-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('remarkPanel').style.display = 'none';
  document.getElementById('remarkOtherBox').style.display = 'none';
  document.getElementById('remarkOtherInput').value = '';
}

function updateChecklistUI() {
  let html = ""; let isAllMatched = true; let hasOverScan = false;
  expectedItemsArray.forEach(item => {
    let scanQty = scannedItemsMap[item.sku] || 0;
    let statusClass = "", icon = "‚è≥";
    if (scanQty === item.qty) { statusClass = "matched"; icon = "‚úÖ"; }
    else if (scanQty > item.qty) { statusClass = "over"; icon = "‚ùå"; isAllMatched = false; hasOverScan = true; }
    else { isAllMatched = false; }
    html += `<div class="checklist-item ${statusClass}"><span>${icon} ${productMap[item.sku] || item.sku}</span><span class="badge bg-${scanQty === item.qty ? 'success' : (scanQty > item.qty ? 'danger' : 'secondary')} rounded-pill">${scanQty} / ${item.qty}</span></div>`;
  });
  for (let sSku in scannedItemsMap) {
    if (!expectedItemsArray.find(ex => ex.sku === sSku) && scannedItemsMap[sSku] > 0) {
      html += `<div class="checklist-item over"><span>‚ùå ${productMap[sSku] || sSku} (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô!)</span><span class="badge bg-danger rounded-pill">${scannedItemsMap[sSku]}</span></div>`;
      isAllMatched = false; hasOverScan = true;
    }
  }
  document.getElementById('checklistContent').innerHTML = html;
  const alertBox = document.getElementById('orderStatusAlert');
  alertBox.style.display = 'block';
  if (isAllMatched && !hasOverScan) { alertBox.className = "alert alert-success mt-2 mb-0 py-2"; alertBox.innerHTML = "<strong>‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!</strong> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"; }
  else if (hasOverScan) { alertBox.className = "alert alert-danger mt-2 mb-0 py-2"; alertBox.innerHTML = "<strong>‡∏£‡∏∞‡∏ß‡∏±‡∏á!</strong> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"; }
  else { alertBox.className = "alert alert-warning mt-2 mb-0 py-2"; alertBox.innerHTML = "<strong>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Å...</strong> ‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà"; }
}

function validateCurrentOrder() {
  if (!isStrictValidationMode) return true;
  for (let item of expectedItemsArray) { if ((scannedItemsMap[item.sku] || 0) !== item.qty) return false; }
  for (let sSku in scannedItemsMap) {
    let reqItem = expectedItemsArray.find(ex => ex.sku === sSku);
    if (!reqItem || scannedItemsMap[sSku] > reqItem.qty) return false;
  }
  return true;
}

// --- Upload Marketplace ---
async function processFileUpload() {
  const fileInput = document.getElementById('fileInput');
  const marketplace = document.getElementById('marketplaceSelect').value;
  if (!fileInput.files.length) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', 'warning'); return; }

  Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  const file = fileInput.files[0];
  const map = colMappings[marketplace];

  try {
    let rows = [];

    // Page365 ‡πÄ‡∏õ‡πá‡∏ô CSV (Tab-separated, UTF-16)
    if (map.isCsv) {
      const text = await file.text();
      const lines = text.split('\n').map(l => l.split('\t'));
      rows = lines;
    } else {
      const buffer = await file.arrayBuffer();
      const workbook = XLSX.read(new Uint8Array(buffer), { type: 'array' });
      rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, raw: false });
    }

    let extractData = [];
    const startRow = map.headerRows || 1;

    if (marketplace === 'lazada') {
      // Lazada: 1 row = 1 ‡∏ä‡∏¥‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ qty column ‚Äî group by tracking
      const trackingMap = {};
      for (let i = startRow; i < rows.length; i++) {
        const row = rows[i];
        if (!row) continue;
        const tracking = String(row[map.tracking] || '').trim().toUpperCase();
        const sku      = String(row[map.sku]      || '').trim().toUpperCase();
        if (!tracking || !sku || tracking === 'UNDEFINED' || sku === 'UNDEFINED') continue;
        const key = tracking + '|' + sku;
        trackingMap[key] = (trackingMap[key] || 0) + 1;
      }
      for (const key in trackingMap) {
        const [tracking, sku] = key.split('|');
        extractData.push({ marketplace, tracking, sku, qty: trackingMap[key] });
      }
    } else {
      for (let i = startRow; i < rows.length; i++) {
        const row = rows[i];
        if (!row) continue;
        const tracking = String(row[map.tracking] || '').trim().toUpperCase();
        const sku      = String(row[map.sku]      || '').trim().toUpperCase();
        const qty      = parseInt(row[map.qty]) || 1;
        if (!tracking || !sku || tracking === 'UNDEFINED' || sku === 'UNDEFINED') continue;
        if (!tracking.match(/^[A-Z0-9]{5,}$/) && !tracking.match(/^\d{10,}$/)) continue; // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà tracking
        extractData.push({ marketplace, tracking, sku, qty });
      }
    }

    if (extractData.length === 0) {
      Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Marketplace ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå', 'warning');
      return;
    }

    // ‡∏™‡πà‡∏á‡πÑ‡∏õ GAS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô duplicate
    const response = await callGAS("saveMarketplaceData", {
      data: extractData,
      fileName: file.name,  // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à duplicate
      marketplace
    });

    if (response && response.success) {
      const dupMsg = response.duplicateSkipped > 0 ? `\n(‡∏Ç‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥ ${response.duplicateSkipped} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)` : '';
      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${response.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${dupMsg}`, 'success');
      bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
      document.getElementById('fileInput').value = "";
    } else {
      Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (response?.error || ''), 'error');
    }
  } catch (err) {
    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + err.message, 'error');
  }
}

// --- Search ---
function openTab(tab, btn) {
  document.querySelectorAll('#scan, #search, #dash').forEach(el => el.style.display = 'none');
  document.getElementById(tab).style.display = 'block';
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (tab === 'dash') refreshDash();
  if (tab !== 'search' && searchScanner) { searchScanner.clear(); document.getElementById("search-reader").style.display = "none"; }
}

function refreshDash() {
  document.getElementById("d-box").innerText = Object.keys(sessionParcels).length;
  document.getElementById("d-item").innerText = Object.values(sessionParcels).reduce((a, b) => a + b, 0);
}

function resetSession() {
  if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥?")) { sessionParcels = {}; refreshDash(); }
}

function startSearchScan() {
  const readerDiv = document.getElementById("search-reader");
  readerDiv.style.display = "block";
  if (searchScanner) searchScanner.clear();
  searchScanner = new Html5QrcodeScanner("search-reader", { fps: 15, qrbox: { width: 250, height: 250 } });
  searchScanner.render((text) => {
    document.getElementById("searchInput").value = text;
    speak("‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏∞");
    searchScanner.clear().then(() => { readerDiv.style.display = "none"; runSearch(); });
  });
}

function handleEnter(e) { if (e.key === "Enter") runSearch(); }

async function runSearch() {
  const q = document.getElementById("searchInput").value.trim();
  if (!q) return;
  document.getElementById("loadingSearch").style.display = "block";
  document.getElementById("resultBody").innerHTML = "";
  try {
    const res = await callGAS("searchData", { query: q });
    document.getElementById("loadingSearch").style.display = "none";
    const tb = document.getElementById("resultBody"), th = document.getElementById("tableHead");
    tb.innerHTML = ""; th.innerHTML = "";
    if (!res || res.length === 0) {
      tb.innerHTML = "<tr><td colspan='5' class='text-center py-4 text-muted'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
      speak("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞"); return;
    }
    const max = Math.max(...res.map(r => r.length));
    let head = "<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏</th><th>‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</th>";
    for (let i = 3; i < max; i++) head += `<th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${i - 2}</th>`;
    th.innerHTML = head + "</tr>";
    res.forEach(row => {
      let tr = "<tr>";
      row.forEach(cell => { tr += `<td>${String(cell).includes("http") ? `<a href="${cell}" target="_blank" class="btn btn-sm btn-outline-primary">‡∏î‡∏π‡∏Ñ‡∏•‡∏¥‡∏õ</a>` : cell}</td>`; });
      tb.innerHTML += tr + "</tr>";
    });
    const rawItems = res[0].slice(3).filter(i => i && !String(i).includes("http"));
    if (rawItems.length > 0) speak(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${rawItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞`);
    else speak("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞");
  } catch (err) {
    document.getElementById("loadingSearch").style.display = "none";
    Swal.fire('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err.message, 'error');
  }
}
</script>

<script>
// === CAT & PAWS ANIMATIONS ===
(function() {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á floating paws
  const pawBg = document.getElementById('pawBg');
  const pawEmojis = ['üêæ','üå∏','‚ú¶','üíï','üéÄ','‚≠ê'];
  for (let i = 0; i < 18; i++) {
    const el = document.createElement('div');
    el.className = 'paw';
    el.textContent = pawEmojis[i % pawEmojis.length];
    el.style.left = Math.random() * 100 + 'vw';
    el.style.animationDuration = (12 + Math.random() * 16) + 's';
    el.style.animationDelay = (Math.random() * 14) + 's';
    el.style.fontSize = (0.9 + Math.random() * 1.4) + 'rem';
    pawBg.appendChild(el);
  }
})();

// Cat tap animation
function catTap(el) {
  const heart = document.getElementById('catHeart');
  heart.classList.remove('show');
  void heart.offsetWidth; // reflow
  heart.classList.add('show');

  // spawn paw sparkle at tap position
  const rect = el.getBoundingClientRect();
  spawnSparkle(rect.left + rect.width/2, rect.top);
}

// spawn sparkle
function spawnSparkle(x, y) {
  const emojis = ['üêæ','üíï','üå∏','‚ú®','üéÄ'];
  const el = document.createElement('div');
  el.className = 'paw-sparkle';
  el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
  el.style.left = (x - 16) + 'px';
  el.style.top = (y - 16) + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 700);
}

// spawn sparkle on scan success
const origProcessFinal = processFinalScan;
window.processFinalScanWrapped = async function(text) {
  await origProcessFinal(text);
  // sparkle at center screen on product scan
  if (text.trim().toUpperCase().startsWith('B')) {
    spawnSparkle(window.innerWidth/2, window.innerHeight/2);
    setTimeout(() => spawnSparkle(window.innerWidth/2 - 30, window.innerHeight/2 - 20), 150);
  }
};
</script>
</body>
</html>
